<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡化工作測試</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f0f2f5;
        }
        .card {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 4px;
        }
        button:hover { background: #0056b3; }
        .download-btn {
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            display: inline-block;
            margin: 8px 4px;
        }
        .download-btn:hover { 
            background: #218838; 
            text-decoration: none; 
            color: white; 
        }
        h2 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>🛠️ 簡化工作測試</h1>
        <p>直接測試檔案轉換和下載功能</p>
        
        <button onclick="debugLoad()">🔍 檢查載入狀態</button>
        <button onclick="testBasicCSV()">📄 測試 CSV</button>
        <button onclick="testExcel()">📊 測試 Excel</button>
        
        <div id="results"></div>
        <div id="debug" class="debug-info" style="display: none;"></div>
    </div>

    <!-- 直接嵌入轉換器代碼 -->
    <script>
        // 簡化的 CSV 轉換器
        function createCSV(data) {
            const BOM = '\uFEFF';
            let csvContent = BOM;
            
            data.forEach(row => {
                const csvRow = row.map(cell => {
                    const cellStr = String(cell || '');
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });
            
            return new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        }

        // 簡化的 JSON 轉換器
        function createJSON(data) {
            let jsonData;
            if (data.length > 1) {
                const headers = data[0];
                jsonData = data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
            } else {
                jsonData = data;
            }
            
            const jsonString = JSON.stringify(jsonData, null, 2);
            return new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        }

        // 簡化的 Excel XML 轉換器
        function createExcelXML(data, filename = 'excel') {
            let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
<Title>${filename}</Title>
<Created>${new Date().toISOString()}</Created>
</DocumentProperties>
<Worksheet ss:Name="Sheet1">
<Table>`;

            data.forEach((row, rowIndex) => {
                xmlContent += `<Row>`;
                row.forEach(cell => {
                    const cellValue = String(cell || '').replace(/[&<>"']/g, function(char) {
                        const entities = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' };
                        return entities[char];
                    });
                    xmlContent += `<Cell><Data ss:Type="String">${cellValue}</Data></Cell>`;
                });
                xmlContent += `</Row>`;
            });

            xmlContent += `</Table></Worksheet></Workbook>`;
            
            return new Blob([xmlContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
        }

        // 安全下載函數
        function safeDownload(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                addResult(`✅ ${filename} 下載開始`, 'success');
                return true;
            } catch (error) {
                addResult(`❌ 下載失敗: ${error.message}`, 'error');
                return false;
            }
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            results.appendChild(div);
            
            // 同時添加到除錯資訊
            const debug = document.getElementById('debug');
            debug.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        }

        function debugLoad() {
            const debug = document.getElementById('debug');
            debug.style.display = 'block';
            
            addResult('🔍 檢查載入狀態...', 'info');
            
            // 檢查各種全域物件
            const checks = [
                { name: 'SpreadsheetConverter', obj: window.SpreadsheetConverter },
                { name: 'libLoader', obj: window.libLoader },
                { name: 'DocumentConverter', obj: window.DocumentConverter },
                { name: 'FileConverter', obj: window.FileConverter }
            ];
            
            checks.forEach(check => {
                if (typeof check.obj !== 'undefined') {
                    addResult(`✅ ${check.name} 已載入`, 'success');
                } else {
                    addResult(`❌ ${check.name} 未載入`, 'error');
                }
            });
            
            // 檢查內建轉換函數
            addResult('📋 內建轉換函數可用:', 'info');
            addResult('✅ createCSV (內建)', 'success');
            addResult('✅ createJSON (內建)', 'success'); 
            addResult('✅ createExcelXML (內建)', 'success');
        }

        function testBasicCSV() {
            addResult('🔄 測試 CSV 轉換...', 'info');
            
            const testData = [
                ['商品', '價格', '庫存'],
                ['iPhone 15', 35000, 10],
                ['MacBook Pro', 65000, 5],
                ['AirPods Pro', 7000, 20],
                ['iPad Air', 22000, 8]
            ];
            
            try {
                const csvBlob = createCSV(testData);
                addResult(`✅ CSV 產生成功: ${csvBlob.size} bytes`, 'success');
                
                // 創建下載按鈕
                const results = document.getElementById('results');
                const btnDiv = document.createElement('div');
                btnDiv.innerHTML = `
                    <a href="#" class="download-btn" onclick="safeDownload(csvBlob, 'products.csv'); return false;">
                        📄 下載 CSV 檔案
                    </a>
                `;
                results.appendChild(btnDiv);
                
                // 使全域可用
                window.csvBlob = csvBlob;
                
                // 同時建立 JSON
                const jsonBlob = createJSON(testData);
                addResult(`✅ JSON 產生成功: ${jsonBlob.size} bytes`, 'success');
                
                const jsonBtnDiv = document.createElement('div');
                jsonBtnDiv.innerHTML = `
                    <a href="#" class="download-btn" onclick="safeDownload(jsonBlob, 'products.json'); return false;">
                        🔧 下載 JSON 檔案
                    </a>
                `;
                results.appendChild(jsonBtnDiv);
                window.jsonBlob = jsonBlob;
                
            } catch (error) {
                addResult(`❌ CSV 測試失敗: ${error.message}`, 'error');
            }
        }

        function testExcel() {
            addResult('🔄 測試 Excel 轉換...', 'info');
            
            const salesData = [
                ['日期', '業務員', '銷售額', '客戶'],
                ['2024-01-01', '張三', 50000, 'ABC公司'],
                ['2024-01-02', '李四', 35000, 'XYZ企業'],
                ['2024-01-03', '王五', 42000, '123集團'],
                ['2024-01-04', '趙六', 38000, '456公司'],
                ['2024-01-05', '錢七', 55000, '789企業']
            ];
            
            try {
                const excelBlob = createExcelXML(salesData, 'sales-report');
                addResult(`✅ Excel XML 產生成功: ${(excelBlob.size / 1024).toFixed(1)} KB`, 'success');
                
                const results = document.getElementById('results');
                const btnDiv = document.createElement('div');
                btnDiv.innerHTML = `
                    <a href="#" class="download-btn" onclick="safeDownload(excelBlob, 'sales-report.xls'); return false;">
                        📊 下載 Excel 檔案 (.xls)
                    </a>
                `;
                results.appendChild(btnDiv);
                window.excelBlob = excelBlob;
                
                addResult('💡 提示: 下載的 .xls 檔案可以用 Excel、Numbers、Google Sheets 開啟', 'info');
                
            } catch (error) {
                addResult(`❌ Excel 測試失敗: ${error.message}`, 'error');
            }
        }

        // 頁面載入完成後自動檢查
        window.addEventListener('load', () => {
            addResult('🚀 頁面載入完成', 'success');
            setTimeout(debugLoad, 500);
        });
        
        // 將函數設為全域
        window.debugLoad = debugLoad;
        window.testBasicCSV = testBasicCSV;
        window.testExcel = testExcel;
    </script>
</body>
</html>