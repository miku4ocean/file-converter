<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡åŒ–å·¥ä½œæ¸¬è©¦</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f0f2f5;
        }
        .card {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 4px;
        }
        button:hover { background: #0056b3; }
        .download-btn {
            background: #28a745;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            display: inline-block;
            margin: 8px 4px;
        }
        .download-btn:hover { 
            background: #218838; 
            text-decoration: none; 
            color: white; 
        }
        h2 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ› ï¸ ç°¡åŒ–å·¥ä½œæ¸¬è©¦</h1>
        <p>ç›´æ¥æ¸¬è©¦æª”æ¡ˆè½‰æ›å’Œä¸‹è¼‰åŠŸèƒ½</p>
        
        <button onclick="debugLoad()">ğŸ” æª¢æŸ¥è¼‰å…¥ç‹€æ…‹</button>
        <button onclick="testBasicCSV()">ğŸ“„ æ¸¬è©¦ CSV</button>
        <button onclick="testExcel()">ğŸ“Š æ¸¬è©¦ Excel</button>
        
        <div id="results"></div>
        <div id="debug" class="debug-info" style="display: none;"></div>
    </div>

    <!-- ç›´æ¥åµŒå…¥è½‰æ›å™¨ä»£ç¢¼ -->
    <script>
        // ç°¡åŒ–çš„ CSV è½‰æ›å™¨
        function createCSV(data) {
            const BOM = '\uFEFF';
            let csvContent = BOM;
            
            data.forEach(row => {
                const csvRow = row.map(cell => {
                    const cellStr = String(cell || '');
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });
            
            return new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        }

        // ç°¡åŒ–çš„ JSON è½‰æ›å™¨
        function createJSON(data) {
            let jsonData;
            if (data.length > 1) {
                const headers = data[0];
                jsonData = data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
            } else {
                jsonData = data;
            }
            
            const jsonString = JSON.stringify(jsonData, null, 2);
            return new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        }

        // ç°¡åŒ–çš„ Excel XML è½‰æ›å™¨
        function createExcelXML(data, filename = 'excel') {
            let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
<Title>${filename}</Title>
<Created>${new Date().toISOString()}</Created>
</DocumentProperties>
<Worksheet ss:Name="Sheet1">
<Table>`;

            data.forEach((row, rowIndex) => {
                xmlContent += `<Row>`;
                row.forEach(cell => {
                    const cellValue = String(cell || '').replace(/[&<>"']/g, function(char) {
                        const entities = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' };
                        return entities[char];
                    });
                    xmlContent += `<Cell><Data ss:Type="String">${cellValue}</Data></Cell>`;
                });
                xmlContent += `</Row>`;
            });

            xmlContent += `</Table></Worksheet></Workbook>`;
            
            return new Blob([xmlContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
        }

        // å®‰å…¨ä¸‹è¼‰å‡½æ•¸
        function safeDownload(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                addResult(`âœ… ${filename} ä¸‹è¼‰é–‹å§‹`, 'success');
                return true;
            } catch (error) {
                addResult(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            results.appendChild(div);
            
            // åŒæ™‚æ·»åŠ åˆ°é™¤éŒ¯è³‡è¨Š
            const debug = document.getElementById('debug');
            debug.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        }

        function debugLoad() {
            const debug = document.getElementById('debug');
            debug.style.display = 'block';
            
            addResult('ğŸ” æª¢æŸ¥è¼‰å…¥ç‹€æ…‹...', 'info');
            
            // æª¢æŸ¥å„ç¨®å…¨åŸŸç‰©ä»¶
            const checks = [
                { name: 'SpreadsheetConverter', obj: window.SpreadsheetConverter },
                { name: 'libLoader', obj: window.libLoader },
                { name: 'DocumentConverter', obj: window.DocumentConverter },
                { name: 'FileConverter', obj: window.FileConverter }
            ];
            
            checks.forEach(check => {
                if (typeof check.obj !== 'undefined') {
                    addResult(`âœ… ${check.name} å·²è¼‰å…¥`, 'success');
                } else {
                    addResult(`âŒ ${check.name} æœªè¼‰å…¥`, 'error');
                }
            });
            
            // æª¢æŸ¥å…§å»ºè½‰æ›å‡½æ•¸
            addResult('ğŸ“‹ å…§å»ºè½‰æ›å‡½æ•¸å¯ç”¨:', 'info');
            addResult('âœ… createCSV (å…§å»º)', 'success');
            addResult('âœ… createJSON (å…§å»º)', 'success'); 
            addResult('âœ… createExcelXML (å…§å»º)', 'success');
        }

        function testBasicCSV() {
            addResult('ğŸ”„ æ¸¬è©¦ CSV è½‰æ›...', 'info');
            
            const testData = [
                ['å•†å“', 'åƒ¹æ ¼', 'åº«å­˜'],
                ['iPhone 15', 35000, 10],
                ['MacBook Pro', 65000, 5],
                ['AirPods Pro', 7000, 20],
                ['iPad Air', 22000, 8]
            ];
            
            try {
                const csvBlob = createCSV(testData);
                addResult(`âœ… CSV ç”¢ç”ŸæˆåŠŸ: ${csvBlob.size} bytes`, 'success');
                
                // å‰µå»ºä¸‹è¼‰æŒ‰éˆ•
                const results = document.getElementById('results');
                const btnDiv = document.createElement('div');
                btnDiv.innerHTML = `
                    <a href="#" class="download-btn" onclick="safeDownload(csvBlob, 'products.csv'); return false;">
                        ğŸ“„ ä¸‹è¼‰ CSV æª”æ¡ˆ
                    </a>
                `;
                results.appendChild(btnDiv);
                
                // ä½¿å…¨åŸŸå¯ç”¨
                window.csvBlob = csvBlob;
                
                // åŒæ™‚å»ºç«‹ JSON
                const jsonBlob = createJSON(testData);
                addResult(`âœ… JSON ç”¢ç”ŸæˆåŠŸ: ${jsonBlob.size} bytes`, 'success');
                
                const jsonBtnDiv = document.createElement('div');
                jsonBtnDiv.innerHTML = `
                    <a href="#" class="download-btn" onclick="safeDownload(jsonBlob, 'products.json'); return false;">
                        ğŸ”§ ä¸‹è¼‰ JSON æª”æ¡ˆ
                    </a>
                `;
                results.appendChild(jsonBtnDiv);
                window.jsonBlob = jsonBlob;
                
            } catch (error) {
                addResult(`âŒ CSV æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function testExcel() {
            addResult('ğŸ”„ æ¸¬è©¦ Excel è½‰æ›...', 'info');
            
            const salesData = [
                ['æ—¥æœŸ', 'æ¥­å‹™å“¡', 'éŠ·å”®é¡', 'å®¢æˆ¶'],
                ['2024-01-01', 'å¼µä¸‰', 50000, 'ABCå…¬å¸'],
                ['2024-01-02', 'æå››', 35000, 'XYZä¼æ¥­'],
                ['2024-01-03', 'ç‹äº”', 42000, '123é›†åœ˜'],
                ['2024-01-04', 'è¶™å…­', 38000, '456å…¬å¸'],
                ['2024-01-05', 'éŒ¢ä¸ƒ', 55000, '789ä¼æ¥­']
            ];
            
            try {
                const excelBlob = createExcelXML(salesData, 'sales-report');
                addResult(`âœ… Excel XML ç”¢ç”ŸæˆåŠŸ: ${(excelBlob.size / 1024).toFixed(1)} KB`, 'success');
                
                const results = document.getElementById('results');
                const btnDiv = document.createElement('div');
                btnDiv.innerHTML = `
                    <a href="#" class="download-btn" onclick="safeDownload(excelBlob, 'sales-report.xls'); return false;">
                        ğŸ“Š ä¸‹è¼‰ Excel æª”æ¡ˆ (.xls)
                    </a>
                `;
                results.appendChild(btnDiv);
                window.excelBlob = excelBlob;
                
                addResult('ğŸ’¡ æç¤º: ä¸‹è¼‰çš„ .xls æª”æ¡ˆå¯ä»¥ç”¨ Excelã€Numbersã€Google Sheets é–‹å•Ÿ', 'info');
                
            } catch (error) {
                addResult(`âŒ Excel æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            addResult('ğŸš€ é é¢è¼‰å…¥å®Œæˆ', 'success');
            setTimeout(debugLoad, 500);
        });
        
        // å°‡å‡½æ•¸è¨­ç‚ºå…¨åŸŸ
        window.debugLoad = debugLoad;
        window.testBasicCSV = testBasicCSV;
        window.testExcel = testExcel;
    </script>
</body>
</html>