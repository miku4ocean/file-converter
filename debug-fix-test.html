<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©æ¸¬è©¦ - æª”æ¡ˆè½‰æ›å™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #fileInput {
            margin: 10px 0;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æª”æ¡ˆè½‰æ›å™¨ä¿®å¾©æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>1. å‡½å¼åº«è¼‰å…¥æª¢æŸ¥</h2>
        <button onclick="checkLibraryStatus()">æª¢æŸ¥å‡½å¼åº«ç‹€æ…‹</button>
        <div id="libraryStatus" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. SpreadsheetConverter èªæ³•æ¸¬è©¦</h2>
        <button onclick="testSpreadsheetConverter()">æ¸¬è©¦ SpreadsheetConverter</button>
        <div id="spreadsheetResult" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. åŸºæœ¬ Excel è½‰æ›æ¸¬è©¦</h2>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <button onclick="testFileConversion()">æ¸¬è©¦æª”æ¡ˆè½‰æ›</button>
        <div id="conversionResult" class="log"></div>
    </div>

    <div class="test-section">
        <h2>4. æª”æ¡ˆç”¢ç”Ÿæ¸¬è©¦</h2>
        <button onclick="testFileGeneration()">ç”¢ç”Ÿæ¸¬è©¦ CSV</button>
        <button onclick="testExcelGeneration()">ç”¢ç”Ÿæ¸¬è©¦ Excel</button>
        <div id="generationResult" class="log"></div>
    </div>

    <div class="test-section">
        <h2>5. æ§åˆ¶å°æ—¥èªŒ</h2>
        <div id="consoleLog" class="log"></div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="assets/js/lib-loader.js"></script>
    <script src="assets/js/converters/spreadsheet.js"></script>

    <script>
        // æ””æˆª console.log ä¸¦é¡¯ç¤ºåœ¨é é¢ä¸Š
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function addToConsoleLog(message, type = 'log') {
            const consoleDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#d32f2f' : type === 'warn' ? '#f57c00' : '#333';
            logEntry.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(logEntry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsoleLog(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsoleLog(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToConsoleLog(args.join(' '), 'warn');
        };

        // ç­‰å¾…è¼‰å…¥å®Œæˆ
        window.addEventListener('load', function() {
            console.log('âœ… é é¢è¼‰å…¥å®Œæˆ');
            addResult('libraryStatus', 'é é¢è¼‰å…¥å®Œæˆï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦', 'success');
        });

        function addResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            element.appendChild(resultDiv);
        }

        async function checkLibraryStatus() {
            const statusDiv = document.getElementById('libraryStatus');
            statusDiv.innerHTML = '';
            
            try {
                // æª¢æŸ¥ libLoader æ˜¯å¦å­˜åœ¨
                if (typeof window.libLoader === 'undefined') {
                    addResult('libraryStatus', 'âŒ libLoader æœªè¼‰å…¥', 'error');
                    return;
                }
                
                addResult('libraryStatus', 'âœ… libLoader å·²è¼‰å…¥', 'success');
                
                // æª¢æŸ¥ SpreadsheetConverter
                if (typeof window.SpreadsheetConverter === 'undefined') {
                    addResult('libraryStatus', 'âŒ SpreadsheetConverter æœªè¼‰å…¥', 'error');
                    return;
                }
                
                addResult('libraryStatus', 'âœ… SpreadsheetConverter å·²è¼‰å…¥', 'success');
                
                // ç²å–å‡½å¼åº«ç‹€æ…‹
                const status = window.libLoader.getLibraryStatus();
                addResult('libraryStatus', 'å‡½å¼åº«ç‹€æ…‹:', 'info');
                
                Object.entries(status).forEach(([name, info]) => {
                    const icon = info.loaded ? 'âœ…' : 'âŒ';
                    addResult('libraryStatus', `${icon} ${name}: ${info.description}`, info.loaded ? 'success' : 'warning');
                });
                
            } catch (error) {
                addResult('libraryStatus', `âŒ æª¢æŸ¥éŒ¯èª¤: ${error.message}`, 'error');
                console.error('Library status check error:', error);
            }
        }

        function testSpreadsheetConverter() {
            const resultDiv = document.getElementById('spreadsheetResult');
            resultDiv.innerHTML = '';
            
            try {
                // æ¸¬è©¦ escapeHtml æ–¹æ³•
                if (typeof SpreadsheetConverter.escapeHtml === 'function') {
                    const testString = '<script>alert("test")</script>';
                    const escaped = SpreadsheetConverter.escapeHtml(testString);
                    addResult('spreadsheetResult', 'âœ… escapeHtml æ–¹æ³•æ­£å¸¸å·¥ä½œ', 'success');
                    addResult('spreadsheetResult', `æ¸¬è©¦è¼¸å…¥: ${testString}`, 'info');
                    addResult('spreadsheetResult', `è½‰æ›çµæœ: ${escaped}`, 'success');
                } else {
                    addResult('spreadsheetResult', 'âŒ escapeHtml æ–¹æ³•ä¸å­˜åœ¨', 'error');
                }
                
                // æ¸¬è©¦å…¶ä»–æ ¸å¿ƒæ–¹æ³•
                const methods = ['isValidSpreadsheetFile', 'convertToCsv', 'convertToJson'];
                methods.forEach(method => {
                    if (typeof SpreadsheetConverter[method] === 'function') {
                        addResult('spreadsheetResult', `âœ… ${method} æ–¹æ³•å­˜åœ¨`, 'success');
                    } else {
                        addResult('spreadsheetResult', `âŒ ${method} æ–¹æ³•ä¸å­˜åœ¨`, 'error');
                    }
                });
                
            } catch (error) {
                addResult('spreadsheetResult', `âŒ æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
                console.error('SpreadsheetConverter test error:', error);
            }
        }

        async function testFileConversion() {
            const resultDiv = document.getElementById('conversionResult');
            resultDiv.innerHTML = '';
            
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                addResult('conversionResult', 'âš ï¸ è«‹å…ˆé¸æ“‡ä¸€å€‹æª”æ¡ˆ', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            addResult('conversionResult', `é–‹å§‹æ¸¬è©¦æª”æ¡ˆ: ${file.name}`, 'info');
            
            try {
                // æª¢æŸ¥æª”æ¡ˆæ ¼å¼
                const isValid = SpreadsheetConverter.isValidSpreadsheetFile(file);
                addResult('conversionResult', `æª”æ¡ˆæ ¼å¼é©—è­‰: ${isValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ ç„¡æ•ˆ'}`, isValid ? 'success' : 'error');
                
                if (!isValid) {
                    return;
                }
                
                // å˜—è©¦è§£ææª”æ¡ˆ
                const parsedData = await SpreadsheetConverter.parseSpreadsheetData(file);
                addResult('conversionResult', `âœ… æª”æ¡ˆè§£ææˆåŠŸ`, 'success');
                addResult('conversionResult', `è¡Œæ•¸: ${parsedData.rowCount}, åˆ—æ•¸: ${parsedData.columnCount}`, 'info');
                
                // å˜—è©¦è½‰æ›ç‚º CSV
                const csvBlob = await SpreadsheetConverter.convertToFormat(parsedData, 'csv');
                addResult('conversionResult', `âœ… CSV è½‰æ›æˆåŠŸï¼Œæª”æ¡ˆå¤§å°: ${csvBlob.size} bytes`, 'success');
                
                // å˜—è©¦è½‰æ›ç‚º JSON
                const jsonBlob = await SpreadsheetConverter.convertToFormat(parsedData, 'json');
                addResult('conversionResult', `âœ… JSON è½‰æ›æˆåŠŸï¼Œæª”æ¡ˆå¤§å°: ${jsonBlob.size} bytes`, 'success');
                
            } catch (error) {
                addResult('conversionResult', `âŒ è½‰æ›éŒ¯èª¤: ${error.message}`, 'error');
                console.error('File conversion error:', error);
            }
        }

        async function testFileGeneration() {
            const resultDiv = document.getElementById('generationResult');
            resultDiv.innerHTML = '';
            
            try {
                // å‰µå»ºæ¸¬è©¦è³‡æ–™
                const testData = [
                    ['å§“å', 'å¹´é½¡', 'åŸå¸‚'],
                    ['å¼µä¸‰', '25', 'å°åŒ—'],
                    ['æå››', '30', 'å°ä¸­'],
                    ['ç‹äº”', '28', 'é«˜é›„']
                ];
                
                // ç”¢ç”Ÿ CSV
                const csvBlob = SpreadsheetConverter.convertToCsv(testData);
                addResult('generationResult', `âœ… CSV ç”¢ç”ŸæˆåŠŸï¼Œæª”æ¡ˆå¤§å°: ${csvBlob.size} bytes`, 'success');
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const csvUrl = URL.createObjectURL(csvBlob);
                const csvLink = document.createElement('a');
                csvLink.href = csvUrl;
                csvLink.download = 'test.csv';
                csvLink.textContent = 'ä¸‹è¼‰ CSV æª”æ¡ˆ';
                csvLink.style.display = 'block';
                csvLink.style.margin = '10px 0';
                resultDiv.appendChild(csvLink);
                
                // ç”¢ç”Ÿ JSON
                const jsonBlob = SpreadsheetConverter.convertToJson(testData);
                addResult('generationResult', `âœ… JSON ç”¢ç”ŸæˆåŠŸï¼Œæª”æ¡ˆå¤§å°: ${jsonBlob.size} bytes`, 'success');
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const jsonUrl = URL.createObjectURL(jsonBlob);
                const jsonLink = document.createElement('a');
                jsonLink.href = jsonUrl;
                jsonLink.download = 'test.json';
                jsonLink.textContent = 'ä¸‹è¼‰ JSON æª”æ¡ˆ';
                jsonLink.style.display = 'block';
                jsonLink.style.margin = '10px 0';
                resultDiv.appendChild(jsonLink);
                
            } catch (error) {
                addResult('generationResult', `âŒ æª”æ¡ˆç”¢ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                console.error('File generation error:', error);
            }
        }

        async function testExcelGeneration() {
            const resultDiv = document.getElementById('generationResult');
            
            try {
                // å‰µå»ºæ¸¬è©¦è³‡æ–™
                const testData = [
                    ['ç”¢å“åç¨±', 'åƒ¹æ ¼', 'åº«å­˜', 'å‚™è¨»'],
                    ['ç­†è¨˜å‹é›»è…¦', '25000', '10', 'ç†±é–€å•†å“'],
                    ['æ‰‹æ©Ÿ', '15000', '25', 'æ–°å“ä¸Šå¸‚'],
                    ['å¹³æ¿é›»è…¦', '18000', '8', 'é™é‡ç‰ˆ']
                ];

                addResult('generationResult', 'é–‹å§‹ç”¢ç”Ÿ Excel æª”æ¡ˆ...', 'info');
                
                // å˜—è©¦ç”¢ç”Ÿ Excel æª”æ¡ˆ
                const excelBlob = await SpreadsheetConverter.convertToExcel(testData, 'test-excel');
                addResult('generationResult', `âœ… Excel ç”¢ç”ŸæˆåŠŸï¼Œæª”æ¡ˆå¤§å°: ${excelBlob.size} bytes`, 'success');
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const excelUrl = URL.createObjectURL(excelBlob);
                const excelLink = document.createElement('a');
                excelLink.href = excelUrl;
                excelLink.download = 'test.xlsx';
                excelLink.textContent = 'ä¸‹è¼‰ Excel æª”æ¡ˆ';
                excelLink.style.display = 'block';
                excelLink.style.margin = '10px 0';
                resultDiv.appendChild(excelLink);
                
                // é©—è­‰æª”æ¡ˆå¯ä»¥é–‹å•Ÿ
                addResult('generationResult', 'ğŸ“ è«‹ä¸‹è¼‰æª”æ¡ˆä¸¦å˜—è©¦é–‹å•Ÿï¼Œç¢ºèªæ˜¯å¦æ­£å¸¸', 'info');
                
            } catch (error) {
                addResult('generationResult', `âŒ Excel ç”¢ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
                console.error('Excel generation error:', error);
            }
        }

        // éŒ¯èª¤è™•ç†
        window.addEventListener('error', function(event) {
            addResult('consoleLog', `JavaScript éŒ¯èª¤: ${event.error?.message || event.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            addResult('consoleLog', `Promise éŒ¯èª¤: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>