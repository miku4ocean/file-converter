<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>檔案轉換器 - 最終修復測試</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            color: #333;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .test-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .success { 
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); 
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error { 
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); 
            color: #721c24; 
            border-left: 4px solid #dc3545;
        }
        .info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin: 8px 4px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 8px 4px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            text-decoration: none;
            color: white;
        }
        h1 { 
            text-align: center; 
            color: #333;
            margin-bottom: 15px;
            font-size: 2.2em;
        }
        h2 { 
            color: #667eea; 
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            font-size: 1.3em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #6c757d;
            font-size: 14px;
        }
        .download-area {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 15px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 檔案轉換器 - 最終修復驗證</h1>
        <p class="subtitle">全面測試修復後的檔案轉換和下載功能</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h2>🔧 載入狀態檢查</h2>
                <button onclick="checkLoadStatus()">檢查系統狀態</button>
                <div id="load-status"></div>
            </div>

            <div class="test-card">
                <h2>📊 Excel 轉換測試</h2>
                <button onclick="testExcelConversion()">測試 Excel 轉換</button>
                <div id="excel-results"></div>
            </div>

            <div class="test-card">
                <h2>📈 CSV 轉換測試</h2>
                <button onclick="testCSVConversion()">測試 CSV 轉換</button>
                <div id="csv-results"></div>
            </div>

            <div class="test-card">
                <h2>🔧 JSON 轉換測試</h2>
                <button onclick="testJSONConversion()">測試 JSON 轉換</button>
                <div id="json-results"></div>
            </div>

            <div class="test-card">
                <h2>🌐 HTML 轉換測試</h2>
                <button onclick="testHTMLConversion()">測試 HTML 轉換</button>
                <div id="html-results"></div>
            </div>

            <div class="test-card">
                <h2>🎯 綜合下載測試</h2>
                <button onclick="runComprehensiveTest()">執行綜合測試</button>
                <div id="comprehensive-results"></div>
            </div>
        </div>
    </div>

    <script src="assets/js/lib-loader.js"></script>
    <script src="assets/js/converters/spreadsheet.js"></script>

    <script>
        let completedTests = 0;
        const totalTests = 6;

        function updateProgress() {
            const progress = (completedTests / totalTests) * 100;
            document.getElementById('overall-progress').style.width = `${progress}%`;
        }

        function addResult(containerId, message, type = 'info', isHtml = false) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            if (isHtml) {
                div.innerHTML = message;
            } else {
                div.textContent = message;
            }
            container.appendChild(div);
            return div;
        }

        function safeDownload(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                return true;
            } catch (error) {
                console.error('下載失敗:', error);
                return false;
            }
        }

        async function waitForConverter(timeout = 10000) {
            const start = Date.now();
            while (typeof SpreadsheetConverter === 'undefined') {
                if (Date.now() - start > timeout) {
                    throw new Error('SpreadsheetConverter 載入逾時');
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function checkLoadStatus() {
            const containerId = 'load-status';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                addResult(containerId, '🔍 檢查系統載入狀態...', 'info');
                
                // 檢查 SpreadsheetConverter
                try {
                    await waitForConverter(5000);
                    addResult(containerId, '✅ SpreadsheetConverter 已成功載入', 'success');
                } catch (error) {
                    addResult(containerId, `❌ SpreadsheetConverter 載入失敗: ${error.message}`, 'error');
                    return;
                }
                
                // 檢查關鍵方法
                const methods = [
                    'convertToCsv', 'convertToJson', 'convertToHtml', 
                    'convertToExcel', 'escapeHtml', 'formatFileSize'
                ];
                
                methods.forEach(method => {
                    if (typeof SpreadsheetConverter[method] === 'function') {
                        addResult(containerId, `✅ ${method} 方法可用`, 'success');
                    } else {
                        addResult(containerId, `❌ ${method} 方法未找到`, 'error');
                    }
                });
                
                // 檢查 libLoader
                if (typeof window.libLoader !== 'undefined') {
                    addResult(containerId, '✅ libLoader 已載入', 'success');
                    const status = window.libLoader.getLibraryStatus();
                    Object.entries(status).forEach(([name, info]) => {
                        const icon = info.available ? '✅' : '⚠️';
                        addResult(containerId, `${icon} ${name}: ${info.description}`, info.available ? 'success' : 'warning');
                    });
                } else {
                    addResult(containerId, '⚠️ libLoader 未載入', 'warning');
                }
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `❌ 載入檢查失敗: ${error.message}`, 'error');
            }
        }

        async function testExcelConversion() {
            const containerId = 'excel-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                addResult(containerId, '🔄 開始 Excel 轉換測試...', 'info');
                
                const productData = [
                    ['產品編號', '產品名稱', '類別', '價格', '庫存'],
                    ['P001', 'iPhone 15 Pro Max', '智慧型手機', 42900, 25],
                    ['P002', 'MacBook Pro 16"', '筆記型電腦', 89900, 10],
                    ['P003', 'AirPods Pro 2', '音響設備', 7490, 50],
                    ['P004', 'iPad Pro 12.9"', '平板電腦', 35900, 15],
                    ['P005', 'Apple Watch Ultra', '穿戴裝置', 25900, 30]
                ];
                
                const excelBlob = await SpreadsheetConverter.convertToExcel(productData, 'product-catalog');
                
                if (excelBlob.size < 100) {
                    throw new Error('Excel 檔案大小異常，可能生成失敗');
                }
                
                addResult(containerId, `✅ Excel 轉換成功！大小: ${(excelBlob.size / 1024).toFixed(1)} KB`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>📊 Excel 檔案準備完成</strong><br>
                        檔案名稱: product-catalog.xlsx<br>
                        檔案大小: ${(excelBlob.size / 1024).toFixed(1)} KB<br>
                        格式: Microsoft Excel XLSX
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.excelTestBlob, 'product-catalog.xlsx'); return false;">
                        📊 下載 Excel 檔案
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.excelTestBlob = excelBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `❌ Excel 轉換失敗: ${error.message}`, 'error');
                console.error('Excel conversion error:', error);
            }
        }

        async function testCSVConversion() {
            const containerId = 'csv-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                const employeeData = [
                    ['員工編號', '姓名', '部門', '職位', '薪資', '入職日期'],
                    ['EMP001', '王小明', '資訊部', '高級工程師', 65000, '2022-03-15'],
                    ['EMP002', '李美麗', '行銷部', '行銷經理', 58000, '2021-07-20'],
                    ['EMP003', '張志強', '業務部', '業務主管', 62000, '2020-11-10'],
                    ['EMP004', '陳雅婷', '人力資源', '人資專員', 48000, '2023-01-05'],
                    ['EMP005', '林大華', '財務部', '會計師', 72000, '2019-09-12']
                ];
                
                const csvBlob = SpreadsheetConverter.convertToCsv(employeeData);
                addResult(containerId, `✅ CSV 轉換成功！大小: ${csvBlob.size} bytes`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>📈 CSV 檔案準備完成</strong><br>
                        檔案名稱: employee-data.csv<br>
                        檔案大小: ${csvBlob.size} bytes<br>
                        編碼: UTF-8 (含 BOM)
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.csvTestBlob, 'employee-data.csv'); return false;">
                        📈 下載 CSV 檔案
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.csvTestBlob = csvBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `❌ CSV 轉換失敗: ${error.message}`, 'error');
            }
        }

        async function testJSONConversion() {
            const containerId = 'json-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                const customerData = [
                    ['客戶ID', '公司名稱', '聯絡人', '電話', '地址', '信用額度'],
                    ['C001', 'ABC科技公司', '張經理', '02-1234-5678', '台北市信義區', 1000000],
                    ['C002', 'XYZ貿易有限公司', '李總監', '04-2345-6789', '台中市西屯區', 800000],
                    ['C003', '123製造企業', '王協理', '07-3456-7890', '高雄市左營區', 1200000]
                ];
                
                const jsonBlob = SpreadsheetConverter.convertToJson(customerData);
                addResult(containerId, `✅ JSON 轉換成功！大小: ${jsonBlob.size} bytes`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>🔧 JSON 檔案準備完成</strong><br>
                        檔案名稱: customer-data.json<br>
                        檔案大小: ${jsonBlob.size} bytes<br>
                        格式: JSON (JavaScript Object Notation)
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.jsonTestBlob, 'customer-data.json'); return false;">
                        🔧 下載 JSON 檔案
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.jsonTestBlob = jsonBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `❌ JSON 轉換失敗: ${error.message}`, 'error');
            }
        }

        async function testHTMLConversion() {
            const containerId = 'html-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                const reportData = [
                    ['月份', '營收', '支出', '淨利', '成長率'],
                    ['1月', 5000000, 3800000, 1200000, '15%'],
                    ['2月', 5500000, 4100000, 1400000, '25%'],
                    ['3月', 6200000, 4500000, 1700000, '21%']
                ];
                
                const htmlBlob = SpreadsheetConverter.convertToHtml(reportData, 'monthly-report');
                addResult(containerId, `✅ HTML 轉換成功！大小: ${(htmlBlob.size / 1024).toFixed(1)} KB`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>🌐 HTML 檔案準備完成</strong><br>
                        檔案名稱: monthly-report.html<br>
                        檔案大小: ${(htmlBlob.size / 1024).toFixed(1)} KB<br>
                        格式: HTML 表格頁面
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.htmlTestBlob, 'monthly-report.html'); return false;">
                        🌐 下載 HTML 檔案
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.htmlTestBlob = htmlBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `❌ HTML 轉換失敗: ${error.message}`, 'error');
            }
        }

        async function runComprehensiveTest() {
            const containerId = 'comprehensive-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                addResult(containerId, '🔄 執行綜合測試...', 'info');
                
                const inventoryData = [
                    ['商品代碼', '商品名稱', '品牌', '類別', '售價', '成本', '庫存', '供應商'],
                    ['ITM001', 'MacBook Pro 14"', 'Apple', '筆電', 65900, 58000, 12, 'Apple Inc.'],
                    ['ITM002', 'ThinkPad X1 Carbon', 'Lenovo', '筆電', 52900, 46000, 8, 'Lenovo Group'],
                    ['ITM003', 'Surface Pro 9', 'Microsoft', '平板', 35900, 31000, 15, 'Microsoft Corp.'],
                    ['ITM004', 'iPad Pro 11"', 'Apple', '平板', 28900, 25000, 20, 'Apple Inc.'],
                    ['ITM005', 'iPhone 15', 'Apple', '手機', 32900, 28000, 30, 'Apple Inc.']
                ];
                
                const formats = [
                    { name: 'CSV', func: () => SpreadsheetConverter.convertToCsv(inventoryData), ext: 'csv', icon: '📈' },
                    { name: 'JSON', func: () => SpreadsheetConverter.convertToJson(inventoryData), ext: 'json', icon: '🔧' },
                    { name: 'HTML', func: () => SpreadsheetConverter.convertToHtml(inventoryData, 'inventory'), ext: 'html', icon: '🌐' },
                    { name: 'Excel', func: () => SpreadsheetConverter.convertToExcel(inventoryData, 'inventory'), ext: 'xlsx', icon: '📊' }
                ];
                
                const results = [];
                
                for (const format of formats) {
                    try {
                        const blob = await format.func();
                        addResult(containerId, `✅ ${format.name} 格式轉換成功 (${blob.size} bytes)`, 'success');
                        results.push({ format, blob });
                    } catch (error) {
                        addResult(containerId, `❌ ${format.name} 格式轉換失敗: ${error.message}`, 'error');
                    }
                }
                
                if (results.length > 0) {
                    const downloadDiv = document.createElement('div');
                    downloadDiv.className = 'download-area';
                    downloadDiv.innerHTML = `
                        <div class="file-info">
                            <strong>🎉 綜合測試完成！</strong><br>
                            成功生成 ${results.length} 個不同格式的檔案<br>
                            <small>庫存管理表格 - 包含商品資訊、價格、庫存數量</small>
                        </div>
                        ${results.map((result, index) => 
                            `<a href="#" class="download-btn" onclick="safeDownload(window.comprehensiveBlobs[${index}], 'inventory.${result.format.ext}'); return false;">
                                ${result.format.icon} ${result.format.name} (inventory.${result.format.ext})
                            </a>`
                        ).join('')}
                    `;
                    document.getElementById(containerId).appendChild(downloadDiv);
                    window.comprehensiveBlobs = results.map(r => r.blob);
                }
                
                addResult(containerId, '✅ 綜合測試完成！所有檔案都可正常下載使用。', 'success');
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `❌ 綜合測試失敗: ${error.message}`, 'error');
            }
        }

        // 全域函數註冊
        window.checkLoadStatus = checkLoadStatus;
        window.testExcelConversion = testExcelConversion;
        window.testCSVConversion = testCSVConversion;
        window.testJSONConversion = testJSONConversion;
        window.testHTMLConversion = testHTMLConversion;
        window.runComprehensiveTest = runComprehensiveTest;

        // 頁面載入完成後自動執行載入檢查
        window.addEventListener('load', () => {
            setTimeout(checkLoadStatus, 1000);
        });
    </script>
</body>
</html>