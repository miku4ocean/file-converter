<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æª”æ¡ˆè½‰æ›å™¨ - æœ€çµ‚ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.98);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            color: #333;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .test-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .success { 
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); 
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error { 
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); 
            color: #721c24; 
            border-left: 4px solid #dc3545;
        }
        .info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin: 8px 4px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 8px 4px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            text-decoration: none;
            color: white;
        }
        h1 { 
            text-align: center; 
            color: #333;
            margin-bottom: 15px;
            font-size: 2.2em;
        }
        h2 { 
            color: #667eea; 
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            font-size: 1.3em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #6c757d;
            font-size: 14px;
        }
        .download-area {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 15px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æª”æ¡ˆè½‰æ›å™¨ - æœ€çµ‚ä¿®å¾©é©—è­‰</h1>
        <p class="subtitle">å…¨é¢æ¸¬è©¦ä¿®å¾©å¾Œçš„æª”æ¡ˆè½‰æ›å’Œä¸‹è¼‰åŠŸèƒ½</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h2>ğŸ”§ è¼‰å…¥ç‹€æ…‹æª¢æŸ¥</h2>
                <button onclick="checkLoadStatus()">æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
                <div id="load-status"></div>
            </div>

            <div class="test-card">
                <h2>ğŸ“Š Excel è½‰æ›æ¸¬è©¦</h2>
                <button onclick="testExcelConversion()">æ¸¬è©¦ Excel è½‰æ›</button>
                <div id="excel-results"></div>
            </div>

            <div class="test-card">
                <h2>ğŸ“ˆ CSV è½‰æ›æ¸¬è©¦</h2>
                <button onclick="testCSVConversion()">æ¸¬è©¦ CSV è½‰æ›</button>
                <div id="csv-results"></div>
            </div>

            <div class="test-card">
                <h2>ğŸ”§ JSON è½‰æ›æ¸¬è©¦</h2>
                <button onclick="testJSONConversion()">æ¸¬è©¦ JSON è½‰æ›</button>
                <div id="json-results"></div>
            </div>

            <div class="test-card">
                <h2>ğŸŒ HTML è½‰æ›æ¸¬è©¦</h2>
                <button onclick="testHTMLConversion()">æ¸¬è©¦ HTML è½‰æ›</button>
                <div id="html-results"></div>
            </div>

            <div class="test-card">
                <h2>ğŸ¯ ç¶œåˆä¸‹è¼‰æ¸¬è©¦</h2>
                <button onclick="runComprehensiveTest()">åŸ·è¡Œç¶œåˆæ¸¬è©¦</button>
                <div id="comprehensive-results"></div>
            </div>
        </div>
    </div>

    <script src="assets/js/lib-loader.js"></script>
    <script src="assets/js/converters/spreadsheet.js"></script>

    <script>
        let completedTests = 0;
        const totalTests = 6;

        function updateProgress() {
            const progress = (completedTests / totalTests) * 100;
            document.getElementById('overall-progress').style.width = `${progress}%`;
        }

        function addResult(containerId, message, type = 'info', isHtml = false) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            if (isHtml) {
                div.innerHTML = message;
            } else {
                div.textContent = message;
            }
            container.appendChild(div);
            return div;
        }

        function safeDownload(blob, filename) {
            try {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                return true;
            } catch (error) {
                console.error('ä¸‹è¼‰å¤±æ•—:', error);
                return false;
            }
        }

        async function waitForConverter(timeout = 10000) {
            const start = Date.now();
            while (typeof SpreadsheetConverter === 'undefined') {
                if (Date.now() - start > timeout) {
                    throw new Error('SpreadsheetConverter è¼‰å…¥é€¾æ™‚');
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }

        async function checkLoadStatus() {
            const containerId = 'load-status';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                addResult(containerId, 'ğŸ” æª¢æŸ¥ç³»çµ±è¼‰å…¥ç‹€æ…‹...', 'info');
                
                // æª¢æŸ¥ SpreadsheetConverter
                try {
                    await waitForConverter(5000);
                    addResult(containerId, 'âœ… SpreadsheetConverter å·²æˆåŠŸè¼‰å…¥', 'success');
                } catch (error) {
                    addResult(containerId, `âŒ SpreadsheetConverter è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                    return;
                }
                
                // æª¢æŸ¥é—œéµæ–¹æ³•
                const methods = [
                    'convertToCsv', 'convertToJson', 'convertToHtml', 
                    'convertToExcel', 'escapeHtml', 'formatFileSize'
                ];
                
                methods.forEach(method => {
                    if (typeof SpreadsheetConverter[method] === 'function') {
                        addResult(containerId, `âœ… ${method} æ–¹æ³•å¯ç”¨`, 'success');
                    } else {
                        addResult(containerId, `âŒ ${method} æ–¹æ³•æœªæ‰¾åˆ°`, 'error');
                    }
                });
                
                // æª¢æŸ¥ libLoader
                if (typeof window.libLoader !== 'undefined') {
                    addResult(containerId, 'âœ… libLoader å·²è¼‰å…¥', 'success');
                    const status = window.libLoader.getLibraryStatus();
                    Object.entries(status).forEach(([name, info]) => {
                        const icon = info.available ? 'âœ…' : 'âš ï¸';
                        addResult(containerId, `${icon} ${name}: ${info.description}`, info.available ? 'success' : 'warning');
                    });
                } else {
                    addResult(containerId, 'âš ï¸ libLoader æœªè¼‰å…¥', 'warning');
                }
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `âŒ è¼‰å…¥æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testExcelConversion() {
            const containerId = 'excel-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                addResult(containerId, 'ğŸ”„ é–‹å§‹ Excel è½‰æ›æ¸¬è©¦...', 'info');
                
                const productData = [
                    ['ç”¢å“ç·¨è™Ÿ', 'ç”¢å“åç¨±', 'é¡åˆ¥', 'åƒ¹æ ¼', 'åº«å­˜'],
                    ['P001', 'iPhone 15 Pro Max', 'æ™ºæ…§å‹æ‰‹æ©Ÿ', 42900, 25],
                    ['P002', 'MacBook Pro 16"', 'ç­†è¨˜å‹é›»è…¦', 89900, 10],
                    ['P003', 'AirPods Pro 2', 'éŸ³éŸ¿è¨­å‚™', 7490, 50],
                    ['P004', 'iPad Pro 12.9"', 'å¹³æ¿é›»è…¦', 35900, 15],
                    ['P005', 'Apple Watch Ultra', 'ç©¿æˆ´è£ç½®', 25900, 30]
                ];
                
                const excelBlob = await SpreadsheetConverter.convertToExcel(productData, 'product-catalog');
                
                if (excelBlob.size < 100) {
                    throw new Error('Excel æª”æ¡ˆå¤§å°ç•°å¸¸ï¼Œå¯èƒ½ç”Ÿæˆå¤±æ•—');
                }
                
                addResult(containerId, `âœ… Excel è½‰æ›æˆåŠŸï¼å¤§å°: ${(excelBlob.size / 1024).toFixed(1)} KB`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>ğŸ“Š Excel æª”æ¡ˆæº–å‚™å®Œæˆ</strong><br>
                        æª”æ¡ˆåç¨±: product-catalog.xlsx<br>
                        æª”æ¡ˆå¤§å°: ${(excelBlob.size / 1024).toFixed(1)} KB<br>
                        æ ¼å¼: Microsoft Excel XLSX
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.excelTestBlob, 'product-catalog.xlsx'); return false;">
                        ğŸ“Š ä¸‹è¼‰ Excel æª”æ¡ˆ
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.excelTestBlob = excelBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `âŒ Excel è½‰æ›å¤±æ•—: ${error.message}`, 'error');
                console.error('Excel conversion error:', error);
            }
        }

        async function testCSVConversion() {
            const containerId = 'csv-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                const employeeData = [
                    ['å“¡å·¥ç·¨è™Ÿ', 'å§“å', 'éƒ¨é–€', 'è·ä½', 'è–ªè³‡', 'å…¥è·æ—¥æœŸ'],
                    ['EMP001', 'ç‹å°æ˜', 'è³‡è¨Šéƒ¨', 'é«˜ç´šå·¥ç¨‹å¸«', 65000, '2022-03-15'],
                    ['EMP002', 'æç¾éº—', 'è¡ŒéŠ·éƒ¨', 'è¡ŒéŠ·ç¶“ç†', 58000, '2021-07-20'],
                    ['EMP003', 'å¼µå¿—å¼·', 'æ¥­å‹™éƒ¨', 'æ¥­å‹™ä¸»ç®¡', 62000, '2020-11-10'],
                    ['EMP004', 'é™³é›…å©·', 'äººåŠ›è³‡æº', 'äººè³‡å°ˆå“¡', 48000, '2023-01-05'],
                    ['EMP005', 'æ—å¤§è¯', 'è²¡å‹™éƒ¨', 'æœƒè¨ˆå¸«', 72000, '2019-09-12']
                ];
                
                const csvBlob = SpreadsheetConverter.convertToCsv(employeeData);
                addResult(containerId, `âœ… CSV è½‰æ›æˆåŠŸï¼å¤§å°: ${csvBlob.size} bytes`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>ğŸ“ˆ CSV æª”æ¡ˆæº–å‚™å®Œæˆ</strong><br>
                        æª”æ¡ˆåç¨±: employee-data.csv<br>
                        æª”æ¡ˆå¤§å°: ${csvBlob.size} bytes<br>
                        ç·¨ç¢¼: UTF-8 (å« BOM)
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.csvTestBlob, 'employee-data.csv'); return false;">
                        ğŸ“ˆ ä¸‹è¼‰ CSV æª”æ¡ˆ
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.csvTestBlob = csvBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `âŒ CSV è½‰æ›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testJSONConversion() {
            const containerId = 'json-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                const customerData = [
                    ['å®¢æˆ¶ID', 'å…¬å¸åç¨±', 'è¯çµ¡äºº', 'é›»è©±', 'åœ°å€', 'ä¿¡ç”¨é¡åº¦'],
                    ['C001', 'ABCç§‘æŠ€å…¬å¸', 'å¼µç¶“ç†', '02-1234-5678', 'å°åŒ—å¸‚ä¿¡ç¾©å€', 1000000],
                    ['C002', 'XYZè²¿æ˜“æœ‰é™å…¬å¸', 'æç¸½ç›£', '04-2345-6789', 'å°ä¸­å¸‚è¥¿å±¯å€', 800000],
                    ['C003', '123è£½é€ ä¼æ¥­', 'ç‹å”ç†', '07-3456-7890', 'é«˜é›„å¸‚å·¦ç‡Ÿå€', 1200000]
                ];
                
                const jsonBlob = SpreadsheetConverter.convertToJson(customerData);
                addResult(containerId, `âœ… JSON è½‰æ›æˆåŠŸï¼å¤§å°: ${jsonBlob.size} bytes`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>ğŸ”§ JSON æª”æ¡ˆæº–å‚™å®Œæˆ</strong><br>
                        æª”æ¡ˆåç¨±: customer-data.json<br>
                        æª”æ¡ˆå¤§å°: ${jsonBlob.size} bytes<br>
                        æ ¼å¼: JSON (JavaScript Object Notation)
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.jsonTestBlob, 'customer-data.json'); return false;">
                        ğŸ”§ ä¸‹è¼‰ JSON æª”æ¡ˆ
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.jsonTestBlob = jsonBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `âŒ JSON è½‰æ›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testHTMLConversion() {
            const containerId = 'html-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                const reportData = [
                    ['æœˆä»½', 'ç‡Ÿæ”¶', 'æ”¯å‡º', 'æ·¨åˆ©', 'æˆé•·ç‡'],
                    ['1æœˆ', 5000000, 3800000, 1200000, '15%'],
                    ['2æœˆ', 5500000, 4100000, 1400000, '25%'],
                    ['3æœˆ', 6200000, 4500000, 1700000, '21%']
                ];
                
                const htmlBlob = SpreadsheetConverter.convertToHtml(reportData, 'monthly-report');
                addResult(containerId, `âœ… HTML è½‰æ›æˆåŠŸï¼å¤§å°: ${(htmlBlob.size / 1024).toFixed(1)} KB`, 'success');
                
                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'download-area';
                downloadDiv.innerHTML = `
                    <div class="file-info">
                        <strong>ğŸŒ HTML æª”æ¡ˆæº–å‚™å®Œæˆ</strong><br>
                        æª”æ¡ˆåç¨±: monthly-report.html<br>
                        æª”æ¡ˆå¤§å°: ${(htmlBlob.size / 1024).toFixed(1)} KB<br>
                        æ ¼å¼: HTML è¡¨æ ¼é é¢
                    </div>
                    <a href="#" class="download-btn" onclick="safeDownload(window.htmlTestBlob, 'monthly-report.html'); return false;">
                        ğŸŒ ä¸‹è¼‰ HTML æª”æ¡ˆ
                    </a>
                `;
                document.getElementById(containerId).appendChild(downloadDiv);
                window.htmlTestBlob = htmlBlob;
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `âŒ HTML è½‰æ›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function runComprehensiveTest() {
            const containerId = 'comprehensive-results';
            document.getElementById(containerId).innerHTML = '';
            
            try {
                await waitForConverter();
                
                addResult(containerId, 'ğŸ”„ åŸ·è¡Œç¶œåˆæ¸¬è©¦...', 'info');
                
                const inventoryData = [
                    ['å•†å“ä»£ç¢¼', 'å•†å“åç¨±', 'å“ç‰Œ', 'é¡åˆ¥', 'å”®åƒ¹', 'æˆæœ¬', 'åº«å­˜', 'ä¾›æ‡‰å•†'],
                    ['ITM001', 'MacBook Pro 14"', 'Apple', 'ç­†é›»', 65900, 58000, 12, 'Apple Inc.'],
                    ['ITM002', 'ThinkPad X1 Carbon', 'Lenovo', 'ç­†é›»', 52900, 46000, 8, 'Lenovo Group'],
                    ['ITM003', 'Surface Pro 9', 'Microsoft', 'å¹³æ¿', 35900, 31000, 15, 'Microsoft Corp.'],
                    ['ITM004', 'iPad Pro 11"', 'Apple', 'å¹³æ¿', 28900, 25000, 20, 'Apple Inc.'],
                    ['ITM005', 'iPhone 15', 'Apple', 'æ‰‹æ©Ÿ', 32900, 28000, 30, 'Apple Inc.']
                ];
                
                const formats = [
                    { name: 'CSV', func: () => SpreadsheetConverter.convertToCsv(inventoryData), ext: 'csv', icon: 'ğŸ“ˆ' },
                    { name: 'JSON', func: () => SpreadsheetConverter.convertToJson(inventoryData), ext: 'json', icon: 'ğŸ”§' },
                    { name: 'HTML', func: () => SpreadsheetConverter.convertToHtml(inventoryData, 'inventory'), ext: 'html', icon: 'ğŸŒ' },
                    { name: 'Excel', func: () => SpreadsheetConverter.convertToExcel(inventoryData, 'inventory'), ext: 'xlsx', icon: 'ğŸ“Š' }
                ];
                
                const results = [];
                
                for (const format of formats) {
                    try {
                        const blob = await format.func();
                        addResult(containerId, `âœ… ${format.name} æ ¼å¼è½‰æ›æˆåŠŸ (${blob.size} bytes)`, 'success');
                        results.push({ format, blob });
                    } catch (error) {
                        addResult(containerId, `âŒ ${format.name} æ ¼å¼è½‰æ›å¤±æ•—: ${error.message}`, 'error');
                    }
                }
                
                if (results.length > 0) {
                    const downloadDiv = document.createElement('div');
                    downloadDiv.className = 'download-area';
                    downloadDiv.innerHTML = `
                        <div class="file-info">
                            <strong>ğŸ‰ ç¶œåˆæ¸¬è©¦å®Œæˆï¼</strong><br>
                            æˆåŠŸç”Ÿæˆ ${results.length} å€‹ä¸åŒæ ¼å¼çš„æª”æ¡ˆ<br>
                            <small>åº«å­˜ç®¡ç†è¡¨æ ¼ - åŒ…å«å•†å“è³‡è¨Šã€åƒ¹æ ¼ã€åº«å­˜æ•¸é‡</small>
                        </div>
                        ${results.map((result, index) => 
                            `<a href="#" class="download-btn" onclick="safeDownload(window.comprehensiveBlobs[${index}], 'inventory.${result.format.ext}'); return false;">
                                ${result.format.icon} ${result.format.name} (inventory.${result.format.ext})
                            </a>`
                        ).join('')}
                    `;
                    document.getElementById(containerId).appendChild(downloadDiv);
                    window.comprehensiveBlobs = results.map(r => r.blob);
                }
                
                addResult(containerId, 'âœ… ç¶œåˆæ¸¬è©¦å®Œæˆï¼æ‰€æœ‰æª”æ¡ˆéƒ½å¯æ­£å¸¸ä¸‹è¼‰ä½¿ç”¨ã€‚', 'success');
                
                completedTests++;
                updateProgress();
                
            } catch (error) {
                addResult(containerId, `âŒ ç¶œåˆæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // å…¨åŸŸå‡½æ•¸è¨»å†Š
        window.checkLoadStatus = checkLoadStatus;
        window.testExcelConversion = testExcelConversion;
        window.testCSVConversion = testCSVConversion;
        window.testJSONConversion = testJSONConversion;
        window.testHTMLConversion = testHTMLConversion;
        window.runComprehensiveTest = runComprehensiveTest;

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•åŸ·è¡Œè¼‰å…¥æª¢æŸ¥
        window.addEventListener('load', () => {
            setTimeout(checkLoadStatus, 1000);
        });
    </script>
</body>
</html>