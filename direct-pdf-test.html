<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🖨️ 直接PDF轉換測試</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .test-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-primary { background: #3498db; }
        .btn-success { background: #2ecc71; }
        .btn-warning { background: #f39c12; }
        .status { margin: 15px 0; padding: 15px; border-radius: 5px; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .progress { height: 6px; background: #e9ecef; border-radius: 3px; margin: 10px 0; }
        .progress-bar { height: 100%; background: #28a745; border-radius: 3px; transition: width 0.3s; }
        .file-input { margin: 15px 0; padding: 15px; border: 2px dashed #ccc; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖨️ 直接PDF轉換測試</h1>
        <p>測試新的直接PDF轉換功能，保留原始檔案外觀</p>

        <div class="test-section">
            <h2>HTML文件轉PDF</h2>
            <div class="file-input">
                <input type="file" id="htmlFile" accept=".html,.htm">
                <p>選擇HTML檔案</p>
            </div>
            <button class="btn btn-primary" onclick="testHTMLToPDF()">轉換HTML為PDF</button>
            <button class="btn btn-warning" onclick="createSampleHTML()">建立範例HTML</button>
            <div id="htmlStatus" class="status" style="display:none;"></div>
            <div id="htmlProgress" class="progress" style="display:none;">
                <div class="progress-bar" style="width:0%"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>文書檔案轉PDF</h2>
            <div class="file-input">
                <input type="file" id="documentFile" accept=".docx,.doc,.txt,.md,.rtf">
                <p>選擇文書檔案</p>
            </div>
            <button class="btn btn-primary" onclick="testDocumentToPDF()">轉換文書為PDF</button>
            <button class="btn btn-success" onclick="testTextFile()">建立測試文字檔</button>
            <div id="documentStatus" class="status" style="display:none;"></div>
            <div id="documentProgress" class="progress" style="display:none;">
                <div class="progress-bar" style="width:0%"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>測試結果</h2>
            <div id="testResults">點擊上面的按鈕開始測試...</div>
        </div>
    </div>

    <script src="assets/js/converters/direct-pdf.js"></script>
    <script>
        let testResults = [];

        function showStatus(elementId, message, type = 'info') {
            const statusEl = document.getElementById(elementId);
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function updateProgress(elementId, percent) {
            const progressEl = document.getElementById(elementId);
            const progressBar = progressEl.querySelector('.progress-bar');
            progressEl.style.display = 'block';
            progressBar.style.width = percent + '%';
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function addTestResult(test, success, details) {
            testResults.push({
                test, success, details,
                timestamp: new Date().toLocaleString()
            });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsEl = document.getElementById('testResults');
            if (testResults.length === 0) {
                resultsEl.innerHTML = '點擊上面的按鈕開始測試...';
                return;
            }
            resultsEl.innerHTML = testResults.map(result => `
                <div class="status ${result.success ? 'success' : 'error'}">
                    <strong>${result.success ? '✅' : '❌'} ${result.test}</strong><br>
                    <small>${result.timestamp}</small><br>
                    ${result.details}
                </div>
            `).join('');
        }

        async function testHTMLToPDF() {
            const fileInput = document.getElementById('htmlFile');
            if (fileInput.files.length === 0) {
                showStatus('htmlStatus', '請先選擇HTML檔案', 'error');
                return;
            }

            const file = fileInput.files[0];
            try {
                showStatus('htmlStatus', '正在轉換...', 'info');
                updateProgress('htmlProgress', 30);

                const pdfBlob = await DirectPDFConverter.convertToPDF(file);
                
                updateProgress('htmlProgress', 100);
                showStatus('htmlStatus', '轉換成功！', 'success');

                downloadBlob(pdfBlob, file.name.replace(/\\.[^.]+$/, '') + '_direct.pdf');
                addTestResult('HTML轉PDF', true, `檔案: ${file.name}, 大小: ${(pdfBlob.size/1024).toFixed(2)}KB`);

            } catch (error) {
                console.error('HTML轉PDF失敗:', error);
                showStatus('htmlStatus', '轉換失敗: ' + error.message, 'error');
                addTestResult('HTML轉PDF', false, error.message);
            }
        }

        function createSampleHTML() {
            const htmlContent = \`<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>範例文件</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #27ae60; }
        .highlight { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>📊 測試文件</h1>
    <h2>第一章</h2>
    <p>這是一個測試HTML文件，用來展示直接PDF轉換功能。</p>
    <div class="highlight">
        <strong>重點：</strong> 這會保留所有CSS樣式和佈局！
    </div>
    <h2>第二章</h2>
    <ul>
        <li>完整保留視覺外觀</li>
        <li>支援複雜CSS樣式</li>
        <li>類似瀏覽器列印功能</li>
    </ul>
</body>
</html>\`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const file = new File([blob], 'sample.html', { type: 'text/html' });
            
            const fileInput = document.getElementById('htmlFile');
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            
            showStatus('htmlStatus', '已建立範例HTML檔案', 'success');
        }

        async function testDocumentToPDF() {
            const fileInput = document.getElementById('documentFile');
            if (fileInput.files.length === 0) {
                showStatus('documentStatus', '請先選擇文書檔案', 'error');
                return;
            }

            const file = fileInput.files[0];
            try {
                showStatus('documentStatus', '正在轉換...', 'info');
                updateProgress('documentProgress', 30);

                const pdfBlob = await DirectPDFConverter.convertToPDF(file);
                
                updateProgress('documentProgress', 100);
                showStatus('documentStatus', '轉換成功！', 'success');

                downloadBlob(pdfBlob, file.name.replace(/\\.[^.]+$/, '') + '_direct.pdf');
                addTestResult('文書轉PDF', true, `檔案: ${file.name}, 大小: ${(pdfBlob.size/1024).toFixed(2)}KB`);

            } catch (error) {
                console.error('文書轉PDF失敗:', error);
                showStatus('documentStatus', '轉換失敗: ' + error.message, 'error');
                addTestResult('文書轉PDF', false, error.message);
            }
        }

        function testTextFile() {
            const textContent = \`測試文字檔案

這是第一段內容，用來測試直接PDF轉換。

第二段：新的轉換方式會保留文字格式，
包括換行和段落結構。

測試項目：
• 中文字符支援
• 段落格式保留  
• 換行處理

這是真正的檔案轉換，不是內容摘要！

生成時間：\${new Date().toLocaleString()}\`;

            const blob = new Blob([textContent], { type: 'text/plain' });
            const file = new File([blob], 'test.txt', { type: 'text/plain' });
            
            const fileInput = document.getElementById('documentFile');
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            
            showStatus('documentStatus', '已建立測試文字檔', 'success');
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('直接PDF轉換測試頁面載入');
            if (typeof DirectPDFConverter === 'undefined') {
                document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;"><h1>轉換器載入失敗</h1></div>';
            }
        });
    </script>
</body>
</html>