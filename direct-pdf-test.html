<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ¥ PDF æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .result { padding: 15px; margin: 10px 0; border-radius: 8px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { padding: 15px 25px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log { height: 200px; overflow-y: auto; background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç›´æ¥ PDF è½‰æª”æ¸¬è©¦</h1>
        <p>ç›´æ¥æ¸¬è©¦ä¿®å¾©å¾Œçš„ PDF è½‰æª”åŠŸèƒ½ï¼Œä¸ä¾è³´è¤‡é›œçš„è¼‰å…¥æ©Ÿåˆ¶</p>
        
        <div class="result info" id="status">æ­£åœ¨åˆå§‹åŒ–...</div>
        
        <button onclick="testBasicPDF()" id="basicBtn">ğŸ“„ åŸºæœ¬ PDF æ¸¬è©¦</button>
        <button onclick="testSpecialChars()" id="specialBtn">ğŸ”¤ ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦</button>
        <button onclick="testChineseText()" id="chineseBtn">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡æ–‡å­—æ¸¬è©¦</button>
        <button onclick="testErrorHandling()" id="errorBtn">âš ï¸ éŒ¯èª¤è™•ç†æ¸¬è©¦</button>
        
        <div class="result info">
            <strong>æ¸¬è©¦æ—¥èªŒï¼š</strong>
            <div class="log" id="testLog"></div>
        </div>
        
        <div id="testResults"></div>
    </div>

    <!-- ç›´æ¥è¼‰å…¥å¿…è¦çš„å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    
    <!-- ç›´æ¥è¼‰å…¥ DocumentConverter -->
    <script>
        // ç›´æ¥åµŒå…¥ä¿®å¾©å¾Œçš„ DocumentConverter æ ¸å¿ƒåŠŸèƒ½
        class DirectDocumentConverter {
            // ä¿®å¾©å¾Œçš„éœæ…‹æ–¹æ³•
            static escapeXml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            static escapeRtf(text) {
                if (!text) return '';
                return text
                    .replace(/\\/g, '\\\\')
                    .replace(/\{/g, '\\{')
                    .replace(/\}/g, '\\}');
            }

            // ç°¡åŒ–çš„ PDF è½‰æ›æ–¹æ³•
            static async convertTextToPdf(content, filename) {
                try {
                    log('ğŸ”„ é–‹å§‹è½‰æ› PDF...', 'info');
                    
                    // æª¢æŸ¥ jsPDF æ˜¯å¦å¯ç”¨
                    if (typeof jsPDF === 'undefined') {
                        throw new Error('jsPDF å‡½å¼åº«æœªè¼‰å…¥');
                    }

                    // ä½¿ç”¨ jsPDF å‰µå»º PDF
                    const doc = new jsPDF.jsPDF();
                    
                    // è¨­å®šå­—å‹ (ä½¿ç”¨æ”¯æ´ä¸­æ–‡çš„å­—å‹)
                    doc.setFont('helvetica');
                    doc.setFontSize(12);
                    
                    // è™•ç†å…§å®¹
                    const title = filename ? filename.replace('.pdf', '') : 'æ–‡ä»¶';
                    const processedContent = content || '(ç©ºç™½å…§å®¹)';
                    
                    log(`ğŸ“ è™•ç†å…§å®¹: ${processedContent.length} å­—ç¬¦`, 'info');
                    
                    // æ·»åŠ æ¨™é¡Œ
                    doc.setFontSize(16);
                    doc.text(DirectDocumentConverter.escapeXml(title), 20, 20);
                    
                    // æ·»åŠ å…§å®¹ï¼ˆåˆ†è¡Œè™•ç†ï¼‰
                    doc.setFontSize(12);
                    const lines = processedContent.split('\n');
                    let yPosition = 40;
                    
                    lines.forEach((line, index) => {
                        if (yPosition > 280) { // æ›é 
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        // è™•ç†é•·è¡Œï¼ˆè‡ªå‹•æ›è¡Œï¼‰
                        const processedLine = DirectDocumentConverter.escapeXml(line);
                        const splitLines = doc.splitTextToSize(processedLine, 170);
                        
                        splitLines.forEach(splitLine => {
                            if (yPosition > 280) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            doc.text(splitLine, 20, yPosition);
                            yPosition += 6;
                        });
                        
                        // æ®µè½é–“è·
                        if (line.trim() === '') {
                            yPosition += 3;
                        }
                    });
                    
                    // ç”Ÿæˆ PDF Blob
                    const pdfBlob = doc.output('blob');
                    log(`âœ… PDF ç”ŸæˆæˆåŠŸ: ${pdfBlob.size} bytes`, 'success');
                    
                    return pdfBlob;
                    
                } catch (error) {
                    log(`âŒ PDF è½‰æ›å¤±æ•—: ${error.message}`, 'error');
                    throw error;
                }
            }
        }

        let testCount = 0;
        let passedTests = 0;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function addResult(name, success, details) {
            testCount++;
            if (success) passedTests++;
            
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${success ? 'âœ…' : 'âŒ'} ${name}</strong><br>
                ${details}<br>
                <small>æ¸¬è©¦ ${testCount} | é€šéç‡: ${Math.round((passedTests/testCount)*100)}%</small>
            `;
            resultsDiv.appendChild(resultDiv);
            
            updateStatus();
        }

        function updateStatus() {
            const statusDiv = document.getElementById('status');
            const rate = testCount > 0 ? Math.round((passedTests/testCount)*100) : 0;
            statusDiv.className = `result ${rate === 100 ? 'success' : rate >= 75 ? 'warning' : 'error'}`;
            statusDiv.innerHTML = `æ¸¬è©¦é€²åº¦: ${passedTests}/${testCount} é€šé (${rate}%)`;
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        // æ¸¬è©¦å‡½æ•¸
        async function testBasicPDF() {
            log('ğŸ§ª é–‹å§‹åŸºæœ¬ PDF æ¸¬è©¦', 'info');
            const btn = document.getElementById('basicBtn');
            btn.disabled = true;
            
            try {
                const testContent = "Hello World!\né€™æ˜¯åŸºæœ¬çš„ PDF æ¸¬è©¦å…§å®¹ã€‚";
                const pdfBlob = await DirectDocumentConverter.convertTextToPdf(testContent, 'basic-test.pdf');
                
                if (pdfBlob && pdfBlob.size > 0) {
                    addResult('åŸºæœ¬ PDF æ¸¬è©¦', true, `æª”æ¡ˆå¤§å°: ${pdfBlob.size} bytes`);
                    downloadBlob(pdfBlob, 'basic-test.pdf');
                } else {
                    addResult('åŸºæœ¬ PDF æ¸¬è©¦', false, 'ç”¢ç”Ÿçš„æª”æ¡ˆç‚ºç©º');
                }
            } catch (error) {
                addResult('åŸºæœ¬ PDF æ¸¬è©¦', false, error.message);
            } finally {
                btn.disabled = false;
            }
        }

        async function testSpecialChars() {
            log('ğŸ§ª é–‹å§‹ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦', 'info');
            const btn = document.getElementById('specialBtn');
            btn.disabled = true;
            
            try {
                const testContent = "ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦ï¼š& < > \" '\nHTML å¯¦é«”ï¼š&amp; &lt; &gt; &quot; &#39;";
                const pdfBlob = await DirectDocumentConverter.convertTextToPdf(testContent, 'special-chars.pdf');
                
                if (pdfBlob && pdfBlob.size > 0) {
                    addResult('ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦', true, `æª”æ¡ˆå¤§å°: ${pdfBlob.size} bytes`);
                    downloadBlob(pdfBlob, 'special-chars.pdf');
                } else {
                    addResult('ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦', false, 'ç”¢ç”Ÿçš„æª”æ¡ˆç‚ºç©º');
                }
            } catch (error) {
                addResult('ç‰¹æ®Šå­—ç¬¦æ¸¬è©¦', false, error.message);
            } finally {
                btn.disabled = false;
            }
        }

        async function testChineseText() {
            log('ğŸ§ª é–‹å§‹ä¸­æ–‡æ–‡å­—æ¸¬è©¦', 'info');
            const btn = document.getElementById('chineseBtn');
            btn.disabled = true;
            
            try {
                const testContent = `ä¸­æ–‡æ¸¬è©¦æ–‡ä»¶

é€™æ˜¯ç¬¬ä¸€æ®µä¸­æ–‡å…§å®¹ï¼Œæ¸¬è©¦ PDF è½‰æ›æ™‚æ˜¯å¦èƒ½æ­£ç¢ºè™•ç†ä¸­æ–‡å­—ç¬¦ã€‚

ç¬¬äºŒæ®µåŒ…å«æ›´å¤šå…§å®¹ï¼š
- åˆ—è¡¨é …ç›®ä¸€
- åˆ—è¡¨é …ç›®äºŒ
- åˆ—è¡¨é …ç›®ä¸‰

æ··åˆèªè¨€æ¸¬è©¦ï¼š
English: Hello World!
ä¸­æ–‡ï¼šä½ å¥½ä¸–ç•Œï¼
æ—¥æ–‡ï¼šã“ã‚“ã«ã¡ã¯ä¸–ç•Œï¼

çµæŸæ®µè½ã€‚`;
                
                const pdfBlob = await DirectDocumentConverter.convertTextToPdf(testContent, 'chinese-test.pdf');
                
                if (pdfBlob && pdfBlob.size > 0) {
                    addResult('ä¸­æ–‡æ–‡å­—æ¸¬è©¦', true, `æª”æ¡ˆå¤§å°: ${pdfBlob.size} bytes`);
                    downloadBlob(pdfBlob, 'chinese-test.pdf');
                } else {
                    addResult('ä¸­æ–‡æ–‡å­—æ¸¬è©¦', false, 'ç”¢ç”Ÿçš„æª”æ¡ˆç‚ºç©º');
                }
            } catch (error) {
                addResult('ä¸­æ–‡æ–‡å­—æ¸¬è©¦', false, error.message);
            } finally {
                btn.disabled = false;
            }
        }

        async function testErrorHandling() {
            log('ğŸ§ª é–‹å§‹éŒ¯èª¤è™•ç†æ¸¬è©¦', 'info');
            const btn = document.getElementById('errorBtn');
            btn.disabled = true;
            
            try {
                // æ¸¬è©¦ç©ºå…§å®¹
                const pdfBlob1 = await DirectDocumentConverter.convertTextToPdf('', 'empty-test.pdf');
                let test1Success = pdfBlob1 && pdfBlob1.size > 0;
                
                // æ¸¬è©¦ null å…§å®¹
                const pdfBlob2 = await DirectDocumentConverter.convertTextToPdf(null, 'null-test.pdf');
                let test2Success = pdfBlob2 && pdfBlob2.size > 0;
                
                // æ¸¬è©¦ undefined å…§å®¹
                const pdfBlob3 = await DirectDocumentConverter.convertTextToPdf(undefined, 'undefined-test.pdf');
                let test3Success = pdfBlob3 && pdfBlob3.size > 0;
                
                const overallSuccess = test1Success && test2Success && test3Success;
                addResult('éŒ¯èª¤è™•ç†æ¸¬è©¦', overallSuccess, 
                    `ç©ºå…§å®¹: ${test1Success ? 'âœ…' : 'âŒ'} | null: ${test2Success ? 'âœ…' : 'âŒ'} | undefined: ${test3Success ? 'âœ…' : 'âŒ'}`);
                
                if (test1Success) downloadBlob(pdfBlob1, 'empty-test.pdf');
                if (test2Success) downloadBlob(pdfBlob2, 'null-test.pdf');  
                if (test3Success) downloadBlob(pdfBlob3, 'undefined-test.pdf');
                
            } catch (error) {
                addResult('éŒ¯èª¤è™•ç†æ¸¬è©¦', false, error.message);
            } finally {
                btn.disabled = false;
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('ğŸ“„ ç›´æ¥æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'info');
            
            setTimeout(() => {
                if (typeof jsPDF !== 'undefined') {
                    log('âœ… jsPDF å‡½å¼åº«è¼‰å…¥æˆåŠŸ', 'success');
                    document.getElementById('status').innerHTML = 'âœ… ç³»çµ±æº–å‚™å°±ç·’ï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦';
                    document.getElementById('status').className = 'result success';
                } else {
                    log('âŒ jsPDF å‡½å¼åº«è¼‰å…¥å¤±æ•—', 'error');
                    document.getElementById('status').innerHTML = 'âŒ jsPDF å‡½å¼åº«è¼‰å…¥å¤±æ•—';
                    document.getElementById('status').className = 'result error';
                }
            }, 1000);
        });
    </script>
</body>
</html>