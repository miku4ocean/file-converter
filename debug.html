<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - File Converter</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>檔案轉換器除錯頁面</h1>
    
    <div class="section">
        <h2>載入狀態檢查</h2>
        <div id="loadStatus"></div>
        <button onclick="checkLoadStatus()">檢查載入狀態</button>
    </div>
    
    <div class="section">
        <h2>檔案類型測試</h2>
        <input type="file" id="testFile" multiple>
        <button onclick="testFileTypes()">測試檔案類型</button>
        <div id="fileTestResults"></div>
    </div>
    
    <div class="section">
        <h2>CSV 解析測試</h2>
        <button onclick="testCsvParsing()">測試 CSV 解析</button>
        <div id="csvTestResults"></div>
    </div>
    
    <div class="section">
        <h2>錯誤日誌</h2>
        <div id="errorLog"></div>
        <button onclick="clearLog()">清除日誌</button>
    </div>

    <script src="assets/js/lib-loader.js"></script>
    <script src="assets/js/converters/image.js"></script>
    <script src="assets/js/converters/document.js"></script>
    <script src="assets/js/converters/spreadsheet.js"></script>
    <script src="assets/js/converters/presentation.js"></script>
    
    <script>
        // Override console.error to capture errors
        const originalError = console.error;
        const errorLog = document.getElementById('errorLog');
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = new Date().toLocaleTimeString() + ': ' + args.join(' ');
            errorLog.appendChild(errorDiv);
        };
        
        function checkLoadStatus() {
            const statusDiv = document.getElementById('loadStatus');
            let html = '<h3>類別檢查:</h3>';
            
            const classes = [
                { name: 'ImageConverter', obj: window.ImageConverter },
                { name: 'DocumentConverter', obj: window.DocumentConverter },
                { name: 'SpreadsheetConverter', obj: window.SpreadsheetConverter },
                { name: 'PresentationConverter', obj: window.PresentationConverter },
                { name: 'LibraryLoader', obj: window.LibraryLoader }
            ];
            
            classes.forEach(cls => {
                const status = cls.obj ? '✅ 已載入' : '❌ 未載入';
                const className = cls.obj ? 'success' : 'error';
                html += `<div class="${className}">${cls.name}: ${status}</div>`;
            });
            
            statusDiv.innerHTML = html;
        }
        
        function testFileTypes() {
            const fileInput = document.getElementById('testFile');
            const resultsDiv = document.getElementById('fileTestResults');
            
            if (!fileInput.files.length) {
                resultsDiv.innerHTML = '<div class="error">請選擇檔案進行測試</div>';
                return;
            }
            
            let html = '<h3>檔案類型測試結果:</h3>';
            
            Array.from(fileInput.files).forEach((file, index) => {
                html += `<div><strong>檔案 ${index + 1}: ${file.name}</strong></div>`;
                html += `<div>大小: ${formatFileSize(file.size)}</div>`;
                html += `<div>MIME: ${file.type}</div>`;
                
                // Test each converter
                const tests = [
                    { name: '圖片', test: () => window.ImageConverter?.isValidImageFile(file) },
                    { name: '文書', test: () => window.DocumentConverter?.isValidDocumentFile(file) },
                    { name: '表單', test: () => window.SpreadsheetConverter?.isValidSpreadsheetFile(file) },
                    { name: '簡報', test: () => window.PresentationConverter?.isValidPresentationFile(file) }
                ];
                
                tests.forEach(test => {
                    try {
                        const result = test.test();
                        const status = result ? '✅ 支援' : '❌ 不支援';
                        const className = result ? 'success' : '';
                        html += `<div class="${className}">　${test.name}: ${status}</div>`;
                    } catch (error) {
                        html += `<div class="error">　${test.name}: 錯誤 - ${error.message}</div>`;
                    }
                });
                
                html += '<br>';
            });
            
            resultsDiv.innerHTML = html;
        }
        
        async function testCsvParsing() {
            const resultsDiv = document.getElementById('csvTestResults');
            
            try {
                // Create test CSV data
                const csvText = `姓名,年齡,城市,職業
張三,25,台北,工程師
李四,30,台中,設計師
王五,28,高雄,老師`;
                
                const csvBlob = new Blob([csvText], { type: 'text/csv' });
                csvBlob.name = 'test.csv';
                
                resultsDiv.innerHTML = '<div>測試 CSV 解析...</div>';
                
                // Test parsing
                const parsed = await window.SpreadsheetConverter.parseCsv(csvBlob);
                
                let html = '<h3>CSV 解析結果:</h3>';
                html += `<div>行數: ${parsed.rowCount}</div>`;
                html += `<div>列數: ${parsed.columnCount}</div>`;
                html += '<h4>資料預覽:</h4>';
                html += '<table border="1" style="border-collapse: collapse;">';
                
                parsed.data.slice(0, 5).forEach((row, index) => {
                    html += '<tr>';
                    row.forEach(cell => {
                        const tag = index === 0 ? 'th' : 'td';
                        html += `<${tag}>${cell || ''}</${tag}>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                
                // Test conversion to XLSX
                html += '<h4>XLSX 轉換測試:</h4>';
                try {
                    const xlsxBlob = await window.SpreadsheetConverter.convertToExcel(parsed.data, 'test');
                    html += `<div class="success">✅ XLSX 轉換成功 (${formatFileSize(xlsxBlob.size)})</div>`;
                } catch (error) {
                    html += `<div class="error">❌ XLSX 轉換失敗: ${error.message}</div>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">CSV 測試失敗: ${error.message}</div>`;
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function clearLog() {
            document.getElementById('errorLog').innerHTML = '';
        }
        
        // Auto-check on load
        window.addEventListener('load', () => {
            setTimeout(checkLoadStatus, 500);
        });
    </script>
</body>
</html>