<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF è½‰æª”å£“åŠ›æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { border: 1px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; background: #fafafa; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 12px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
        .stat { text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 1.5em; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 0.8em; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ PDF è½‰æª”å£“åŠ›æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ PDF è½‰æª”åœ¨å„ç¨®æ¥µç«¯æ¢ä»¶ä¸‹çš„è¡¨ç¾</p>
        
        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦ç‹€æ…‹</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="progressText">æº–å‚™é–‹å§‹å£“åŠ›æ¸¬è©¦...</div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="completedTests">0</div>
                    <div class="stat-label">å®Œæˆæ¸¬è©¦</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="passedTests">0</div>
                    <div class="stat-label">é€šéæ¸¬è©¦</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">å¤±æ•—æ¸¬è©¦</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="avgTime">0ms</div>
                    <div class="stat-label">å¹³å‡è€—æ™‚</div>
                </div>
            </div>
            
            <button onclick="runStressTest()" id="startBtn">ğŸš€ é–‹å§‹å£“åŠ›æ¸¬è©¦</button>
            <button onclick="runMemoryTest()" id="memoryBtn">ğŸ§  è¨˜æ†¶é«”æ¸¬è©¦</button>
            <button onclick="runConcurrentTest()" id="concurrentBtn">âš¡ ä¸¦ç™¼æ¸¬è©¦</button>
            <button onclick="clearResults()" id="clearBtn">ğŸ§¹ æ¸…é™¤çµæœ</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ æ¸¬è©¦çµæœ</h3>
            <div id="testResults"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ’¾ æ•ˆèƒ½åˆ†æ</h3>
            <div id="performanceAnalysis" class="result info">å°šæœªé–‹å§‹åˆ†æ...</div>
        </div>
    </div>

    <script src="assets/js/lib-loader.js"></script>
    <script>
        let documentConverter;
        let testResults = [];
        let isTestingInProgress = false;
        
        // å£“åŠ›æ¸¬è©¦æ¡ˆä¾‹
        const stressTestCases = [
            {
                name: "æ¥µçŸ­æ–‡å­—",
                content: "A",
                expected: "success"
            },
            {
                name: "ç©ºå­—ä¸²",
                content: "",
                expected: "should_handle"
            },
            {
                name: "å–®è¡Œæ¥µé•·æ–‡å­—",
                content: "é€™æ˜¯ä¸€å€‹éå¸¸é•·çš„å–®è¡Œæ–‡å­—æ¸¬è©¦ï¼Œ".repeat(500),
                expected: "success"
            },
            {
                name: "å¤§é‡æ®µè½",
                content: Array(100).fill("é€™æ˜¯æ¸¬è©¦æ®µè½").join("\n\n"),
                expected: "success"
            },
            {
                name: "ç‰¹æ®ŠUnicodeå­—ç¬¦",
                content: "ğŸŒŸğŸš€ğŸ’âœ¨ğŸ¯ğŸ”¥ğŸ’«â­ğŸŒˆğŸ‰\nè¡¨æƒ…ç¬¦è™Ÿæ¸¬è©¦\næ•¸å­¸ç¬¦è™Ÿï¼šâˆ‘âˆâˆ«âˆšâˆÂ±Ã—Ã·â‰ â‰¤â‰¥\nè²¨å¹£ç¬¦è™Ÿï¼š$â‚¬Â¥Â£â‚¹â‚¿",
                expected: "success"
            },
            {
                name: "å¤§é‡ç‰¹æ®Šå­—ç¬¦",
                content: "&<>\"'&<>\"'".repeat(1000),
                expected: "success"
            },
            {
                name: "æ··åˆèªè¨€æ¥µé•·æ–‡",
                content: "English text ä¸­æ–‡æ–‡å­— æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆ í•œê¸€ í…ìŠ¤íŠ¸ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ğ ÑƒÑÑĞºĞ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ ".repeat(200),
                expected: "success"
            },
            {
                name: "å¤§é‡æ›è¡Œ",
                content: "\n".repeat(1000) + "å…§å®¹åœ¨æ­¤",
                expected: "success"
            },
            {
                name: "HTMLæ¨™ç±¤å…§å®¹",
                content: "<script>alert('test')</script>\n<div>HTMLå…§å®¹</div>\n<p>æ®µè½æ¨™ç±¤&nbsp;</p>",
                expected: "success"
            },
            {
                name: "SQLæ³¨å…¥å˜—è©¦", 
                content: "'; DROP TABLE users; --\nSELECT * FROM passwords;",
                expected: "success"
            }
        ];
        
        window.addEventListener('librariesLoaded', function() {
            console.log('Libraries loaded');
            documentConverter = new DocumentConverter();
            updateProgress(0, 'âœ… ç³»çµ±æº–å‚™å°±ç·’');
        });
        
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function updateStats() {
            const completed = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = completed - passed;
            const avgTime = completed > 0 ? 
                Math.round(testResults.reduce((sum, r) => sum + (r.duration || 0), 0) / completed) : 0;
            
            document.getElementById('completedTests').textContent = completed;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
        }
        
        function addTestResult(name, success, details, duration) {
            const result = { name, success, details, duration, timestamp: new Date() };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${success ? 'âœ…' : 'âŒ'} ${name}</strong><br>
                ${details}<br>
                <small>è€—æ™‚: ${duration}ms | ${result.timestamp.toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            
            updateStats();
        }
        
        async function runSingleStressTest(testCase, index, total) {
            const startTime = performance.now();
            
            try {
                if (!documentConverter) {
                    throw new Error('DocumentConverter æœªåˆå§‹åŒ–');
                }
                
                const filename = `stress-test-${index + 1}.pdf`;
                const pdfBlob = await documentConverter.convertTextToPdf(testCase.content, filename);
                
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                if (!pdfBlob || pdfBlob.size === 0) {
                    throw new Error('ç”¢ç”Ÿçš„PDFæª”æ¡ˆç‚ºç©º');
                }
                
                // æª¢æŸ¥æª”æ¡ˆå¤§å°æ˜¯å¦åˆç†
                const sizeKB = Math.round(pdfBlob.size / 1024);
                const details = `æª”æ¡ˆå¤§å°: ${sizeKB}KB, å…§å®¹é•·åº¦: ${testCase.content.length} å­—ç¬¦`;
                
                addTestResult(testCase.name, true, details, duration);
                
                // è‡ªå‹•ä¸‹è¼‰è¼ƒå°çš„æ¸¬è©¦æª”æ¡ˆ
                if (sizeKB < 100) {
                    downloadBlob(pdfBlob, filename);
                }
                
                return true;
                
            } catch (error) {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                addTestResult(testCase.name, false, `éŒ¯èª¤: ${error.message}`, duration);
                console.error(`å£“åŠ›æ¸¬è©¦å¤±æ•— [${testCase.name}]:`, error);
                return false;
            }
        }
        
        async function runStressTest() {
            if (isTestingInProgress) return;
            
            isTestingInProgress = true;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'ğŸ”„ æ¸¬è©¦ä¸­...';
            
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            
            console.log('ğŸ”¥ é–‹å§‹å£“åŠ›æ¸¬è©¦...');
            updateProgress(0, 'é–‹å§‹å£“åŠ›æ¸¬è©¦...');
            
            try {
                for (let i = 0; i < stressTestCases.length; i++) {
                    const progress = Math.round(((i + 1) / stressTestCases.length) * 100);
                    updateProgress(progress, `åŸ·è¡Œæ¸¬è©¦ ${i + 1}/${stressTestCases.length}: ${stressTestCases[i].name}`);
                    
                    await runSingleStressTest(stressTestCases[i], i, stressTestCases.length);
                    
                    // çµ¦ç€è¦½å™¨ä¸€é»æ™‚é–“è™•ç†
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                analyzePerformance();
                updateProgress(100, 'âœ… å£“åŠ›æ¸¬è©¦å®Œæˆ');
                
            } catch (error) {
                console.error('å£“åŠ›æ¸¬è©¦éç¨‹éŒ¯èª¤:', error);
                updateProgress(100, 'âŒ æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤');
            } finally {
                isTestingInProgress = false;
                startBtn.disabled = false;
                startBtn.textContent = 'ğŸš€ é–‹å§‹å£“åŠ›æ¸¬è©¦';
            }
        }
        
        async function runMemoryTest() {
            if (isTestingInProgress) return;
            
            console.log('ğŸ§  é–‹å§‹è¨˜æ†¶é«”æ¸¬è©¦...');
            const memoryBtn = document.getElementById('memoryBtn');
            memoryBtn.disabled = true;
            memoryBtn.textContent = 'ğŸ”„ è¨˜æ†¶é«”æ¸¬è©¦ä¸­...';
            
            try {
                // è¨˜éŒ„åˆå§‹è¨˜æ†¶é«”ä½¿ç”¨é‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : null;
                
                // å¿«é€Ÿé€£çºŒè½‰æ›å¤šå€‹PDF
                const testContent = "è¨˜æ†¶é«”æ¸¬è©¦å…§å®¹ ".repeat(1000);
                const promises = [];
                
                for (let i = 0; i < 10; i++) {
                    const promise = documentConverter.convertTextToPdf(testContent, `memory-test-${i}.pdf`);
                    promises.push(promise);
                }
                
                const results = await Promise.allSettled(promises);
                const successful = results.filter(r => r.status === 'fulfilled').length;
                
                // æª¢æŸ¥æœ€çµ‚è¨˜æ†¶é«”ä½¿ç”¨é‡
                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : null;
                
                let memoryReport = `ä¸¦ç™¼è½‰æ›: ${successful}/10 æˆåŠŸ`;
                if (initialMemory && finalMemory) {
                    const memoryIncrease = Math.round((finalMemory - initialMemory) / 1024 / 1024 * 100) / 100;
                    memoryReport += `\nè¨˜æ†¶é«”å¢åŠ : ${memoryIncrease}MB`;
                }
                
                const analysisDiv = document.getElementById('performanceAnalysis');
                analysisDiv.innerHTML = `<strong>è¨˜æ†¶é«”æ¸¬è©¦çµæœ:</strong><br>${memoryReport.replace(/\n/g, '<br>')}`;
                
            } catch (error) {
                console.error('è¨˜æ†¶é«”æ¸¬è©¦å¤±æ•—:', error);
            } finally {
                memoryBtn.disabled = false;
                memoryBtn.textContent = 'ğŸ§  è¨˜æ†¶é«”æ¸¬è©¦';
            }
        }
        
        async function runConcurrentTest() {
            if (isTestingInProgress) return;
            
            console.log('âš¡ é–‹å§‹ä¸¦ç™¼æ¸¬è©¦...');
            const concurrentBtn = document.getElementById('concurrentBtn');
            concurrentBtn.disabled = true;
            concurrentBtn.textContent = 'ğŸ”„ ä¸¦ç™¼æ¸¬è©¦ä¸­...';
            
            try {
                const startTime = performance.now();
                
                // åŒæ™‚åŸ·è¡Œå¤šå€‹ä¸åŒçš„è½‰æ›ä»»å‹™
                const tasks = [
                    documentConverter.convertTextToPdf("ä¸¦ç™¼æ¸¬è©¦ 1", "concurrent-1.pdf"),
                    documentConverter.convertTextToPdf("ä¸¦ç™¼æ¸¬è©¦ 2\nç¬¬äºŒæ®µè½", "concurrent-2.pdf"),
                    documentConverter.convertTextToPdf("ç‰¹æ®Šå­—ç¬¦: & < > \" '", "concurrent-3.pdf"),
                    documentConverter.convertTextToPdf("ä¸­æ–‡ä¸¦ç™¼æ¸¬è©¦\nå¤šæ®µè½å…§å®¹", "concurrent-4.pdf"),
                    documentConverter.convertTextToPdf("é•·æ–‡å­—æ¸¬è©¦ ".repeat(100), "concurrent-5.pdf")
                ];
                
                const results = await Promise.allSettled(tasks);
                const endTime = performance.now();
                
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const totalTime = Math.round(endTime - startTime);
                
                const concurrentReport = `
                    ä¸¦ç™¼ä»»å‹™: ${successful}/5 æˆåŠŸ<br>
                    ç¸½è€—æ™‚: ${totalTime}ms<br>
                    å¹³å‡æ¯å€‹ä»»å‹™: ${Math.round(totalTime / tasks.length)}ms
                `;
                
                const analysisDiv = document.getElementById('performanceAnalysis');
                analysisDiv.innerHTML = `<strong>ä¸¦ç™¼æ¸¬è©¦çµæœ:</strong><br>${concurrentReport}`;
                
            } catch (error) {
                console.error('ä¸¦ç™¼æ¸¬è©¦å¤±æ•—:', error);
            } finally {
                concurrentBtn.disabled = false;
                concurrentBtn.textContent = 'âš¡ ä¸¦ç™¼æ¸¬è©¦';
            }
        }
        
        function analyzePerformance() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = total - passed;
            const successRate = Math.round((passed / total) * 100);
            
            const durations = testResults.filter(r => r.duration).map(r => r.duration);
            const avgDuration = durations.length > 0 ? 
                Math.round(durations.reduce((sum, d) => sum + d, 0) / durations.length) : 0;
            const maxDuration = durations.length > 0 ? Math.max(...durations) : 0;
            const minDuration = durations.length > 0 ? Math.min(...durations) : 0;
            
            let analysis = `
                <strong>ğŸ“Š æ•ˆèƒ½åˆ†æçµæœ:</strong><br>
                æˆåŠŸç‡: ${successRate}% (${passed}/${total})<br>
                å¹³å‡è€—æ™‚: ${avgDuration}ms<br>
                æœ€å¿«: ${minDuration}ms | æœ€æ…¢: ${maxDuration}ms<br>
            `;
            
            if (successRate === 100) {
                analysis += '<br><span style="color: #28a745;">ğŸ‰ æ‰€æœ‰å£“åŠ›æ¸¬è©¦é€šéï¼ç³»çµ±ç©©å®šæ€§æ¥µä½³</span>';
            } else if (successRate >= 90) {
                analysis += '<br><span style="color: #ffc107;">âš ï¸ å¤§éƒ¨åˆ†æ¸¬è©¦é€šéï¼Œç³»çµ±åŸºæœ¬ç©©å®š</span>';
            } else {
                analysis += '<br><span style="color: #dc3545;">âŒ å¤šé …æ¸¬è©¦å¤±æ•—ï¼Œéœ€è¦å„ªåŒ–</span>';
            }
            
            document.getElementById('performanceAnalysis').innerHTML = analysis;
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('performanceAnalysis').innerHTML = '<div class="info">å°šæœªé–‹å§‹åˆ†æ...</div>';
            updateStats();
            updateProgress(0, 'çµæœå·²æ¸…é™¤');
        }
        
        window.addEventListener('load', function() {
            console.log('å£“åŠ›æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');
        });
    </script>
</body>
</html>