<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 轉檔壓力測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { border: 1px solid #ddd; margin: 15px 0; padding: 20px; border-radius: 8px; background: #fafafa; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 12px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
        .stat { text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-number { font-size: 1.5em; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 0.8em; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔥 PDF 轉檔壓力測試</h1>
        <p>測試 PDF 轉檔在各種極端條件下的表現</p>
        
        <div class="test-section">
            <h3>📊 測試狀態</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="progressText">準備開始壓力測試...</div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="completedTests">0</div>
                    <div class="stat-label">完成測試</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="passedTests">0</div>
                    <div class="stat-label">通過測試</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">失敗測試</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="avgTime">0ms</div>
                    <div class="stat-label">平均耗時</div>
                </div>
            </div>
            
            <button onclick="runStressTest()" id="startBtn">🚀 開始壓力測試</button>
            <button onclick="runMemoryTest()" id="memoryBtn">🧠 記憶體測試</button>
            <button onclick="runConcurrentTest()" id="concurrentBtn">⚡ 並發測試</button>
            <button onclick="clearResults()" id="clearBtn">🧹 清除結果</button>
        </div>
        
        <div class="test-section">
            <h3>📝 測試結果</h3>
            <div id="testResults"></div>
        </div>
        
        <div class="test-section">
            <h3>💾 效能分析</h3>
            <div id="performanceAnalysis" class="result info">尚未開始分析...</div>
        </div>
    </div>

    <script src="assets/js/lib-loader.js"></script>
    <script>
        let documentConverter;
        let testResults = [];
        let isTestingInProgress = false;
        
        // 壓力測試案例
        const stressTestCases = [
            {
                name: "極短文字",
                content: "A",
                expected: "success"
            },
            {
                name: "空字串",
                content: "",
                expected: "should_handle"
            },
            {
                name: "單行極長文字",
                content: "這是一個非常長的單行文字測試，".repeat(500),
                expected: "success"
            },
            {
                name: "大量段落",
                content: Array(100).fill("這是測試段落").join("\n\n"),
                expected: "success"
            },
            {
                name: "特殊Unicode字符",
                content: "🌟🚀💎✨🎯🔥💫⭐🌈🎉\n表情符號測試\n數學符號：∑∏∫√∞±×÷≠≤≥\n貨幣符號：$€¥£₹₿",
                expected: "success"
            },
            {
                name: "大量特殊字符",
                content: "&<>\"'&<>\"'".repeat(1000),
                expected: "success"
            },
            {
                name: "混合語言極長文",
                content: "English text 中文文字 日本語テキスト 한글 텍스트 العربية Русский текст ".repeat(200),
                expected: "success"
            },
            {
                name: "大量換行",
                content: "\n".repeat(1000) + "內容在此",
                expected: "success"
            },
            {
                name: "HTML標籤內容",
                content: "<script>alert('test')</script>\n<div>HTML內容</div>\n<p>段落標籤&nbsp;</p>",
                expected: "success"
            },
            {
                name: "SQL注入嘗試", 
                content: "'; DROP TABLE users; --\nSELECT * FROM passwords;",
                expected: "success"
            }
        ];
        
        window.addEventListener('librariesLoaded', function() {
            console.log('Libraries loaded');
            documentConverter = new DocumentConverter();
            updateProgress(0, '✅ 系統準備就緒');
        });
        
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function updateStats() {
            const completed = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = completed - passed;
            const avgTime = completed > 0 ? 
                Math.round(testResults.reduce((sum, r) => sum + (r.duration || 0), 0) / completed) : 0;
            
            document.getElementById('completedTests').textContent = completed;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
        }
        
        function addTestResult(name, success, details, duration) {
            const result = { name, success, details, duration, timestamp: new Date() };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${success ? '✅' : '❌'} ${name}</strong><br>
                ${details}<br>
                <small>耗時: ${duration}ms | ${result.timestamp.toLocaleTimeString()}</small>
            `;
            resultsDiv.appendChild(resultDiv);
            
            updateStats();
        }
        
        async function runSingleStressTest(testCase, index, total) {
            const startTime = performance.now();
            
            try {
                if (!documentConverter) {
                    throw new Error('DocumentConverter 未初始化');
                }
                
                const filename = `stress-test-${index + 1}.pdf`;
                const pdfBlob = await documentConverter.convertTextToPdf(testCase.content, filename);
                
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                if (!pdfBlob || pdfBlob.size === 0) {
                    throw new Error('產生的PDF檔案為空');
                }
                
                // 檢查檔案大小是否合理
                const sizeKB = Math.round(pdfBlob.size / 1024);
                const details = `檔案大小: ${sizeKB}KB, 內容長度: ${testCase.content.length} 字符`;
                
                addTestResult(testCase.name, true, details, duration);
                
                // 自動下載較小的測試檔案
                if (sizeKB < 100) {
                    downloadBlob(pdfBlob, filename);
                }
                
                return true;
                
            } catch (error) {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                addTestResult(testCase.name, false, `錯誤: ${error.message}`, duration);
                console.error(`壓力測試失敗 [${testCase.name}]:`, error);
                return false;
            }
        }
        
        async function runStressTest() {
            if (isTestingInProgress) return;
            
            isTestingInProgress = true;
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = '🔄 測試中...';
            
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            
            console.log('🔥 開始壓力測試...');
            updateProgress(0, '開始壓力測試...');
            
            try {
                for (let i = 0; i < stressTestCases.length; i++) {
                    const progress = Math.round(((i + 1) / stressTestCases.length) * 100);
                    updateProgress(progress, `執行測試 ${i + 1}/${stressTestCases.length}: ${stressTestCases[i].name}`);
                    
                    await runSingleStressTest(stressTestCases[i], i, stressTestCases.length);
                    
                    // 給瀏覽器一點時間處理
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                analyzePerformance();
                updateProgress(100, '✅ 壓力測試完成');
                
            } catch (error) {
                console.error('壓力測試過程錯誤:', error);
                updateProgress(100, '❌ 測試過程發生錯誤');
            } finally {
                isTestingInProgress = false;
                startBtn.disabled = false;
                startBtn.textContent = '🚀 開始壓力測試';
            }
        }
        
        async function runMemoryTest() {
            if (isTestingInProgress) return;
            
            console.log('🧠 開始記憶體測試...');
            const memoryBtn = document.getElementById('memoryBtn');
            memoryBtn.disabled = true;
            memoryBtn.textContent = '🔄 記憶體測試中...';
            
            try {
                // 記錄初始記憶體使用量（如果可用）
                const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : null;
                
                // 快速連續轉換多個PDF
                const testContent = "記憶體測試內容 ".repeat(1000);
                const promises = [];
                
                for (let i = 0; i < 10; i++) {
                    const promise = documentConverter.convertTextToPdf(testContent, `memory-test-${i}.pdf`);
                    promises.push(promise);
                }
                
                const results = await Promise.allSettled(promises);
                const successful = results.filter(r => r.status === 'fulfilled').length;
                
                // 檢查最終記憶體使用量
                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : null;
                
                let memoryReport = `並發轉換: ${successful}/10 成功`;
                if (initialMemory && finalMemory) {
                    const memoryIncrease = Math.round((finalMemory - initialMemory) / 1024 / 1024 * 100) / 100;
                    memoryReport += `\n記憶體增加: ${memoryIncrease}MB`;
                }
                
                const analysisDiv = document.getElementById('performanceAnalysis');
                analysisDiv.innerHTML = `<strong>記憶體測試結果:</strong><br>${memoryReport.replace(/\n/g, '<br>')}`;
                
            } catch (error) {
                console.error('記憶體測試失敗:', error);
            } finally {
                memoryBtn.disabled = false;
                memoryBtn.textContent = '🧠 記憶體測試';
            }
        }
        
        async function runConcurrentTest() {
            if (isTestingInProgress) return;
            
            console.log('⚡ 開始並發測試...');
            const concurrentBtn = document.getElementById('concurrentBtn');
            concurrentBtn.disabled = true;
            concurrentBtn.textContent = '🔄 並發測試中...';
            
            try {
                const startTime = performance.now();
                
                // 同時執行多個不同的轉換任務
                const tasks = [
                    documentConverter.convertTextToPdf("並發測試 1", "concurrent-1.pdf"),
                    documentConverter.convertTextToPdf("並發測試 2\n第二段落", "concurrent-2.pdf"),
                    documentConverter.convertTextToPdf("特殊字符: & < > \" '", "concurrent-3.pdf"),
                    documentConverter.convertTextToPdf("中文並發測試\n多段落內容", "concurrent-4.pdf"),
                    documentConverter.convertTextToPdf("長文字測試 ".repeat(100), "concurrent-5.pdf")
                ];
                
                const results = await Promise.allSettled(tasks);
                const endTime = performance.now();
                
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const totalTime = Math.round(endTime - startTime);
                
                const concurrentReport = `
                    並發任務: ${successful}/5 成功<br>
                    總耗時: ${totalTime}ms<br>
                    平均每個任務: ${Math.round(totalTime / tasks.length)}ms
                `;
                
                const analysisDiv = document.getElementById('performanceAnalysis');
                analysisDiv.innerHTML = `<strong>並發測試結果:</strong><br>${concurrentReport}`;
                
            } catch (error) {
                console.error('並發測試失敗:', error);
            } finally {
                concurrentBtn.disabled = false;
                concurrentBtn.textContent = '⚡ 並發測試';
            }
        }
        
        function analyzePerformance() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = total - passed;
            const successRate = Math.round((passed / total) * 100);
            
            const durations = testResults.filter(r => r.duration).map(r => r.duration);
            const avgDuration = durations.length > 0 ? 
                Math.round(durations.reduce((sum, d) => sum + d, 0) / durations.length) : 0;
            const maxDuration = durations.length > 0 ? Math.max(...durations) : 0;
            const minDuration = durations.length > 0 ? Math.min(...durations) : 0;
            
            let analysis = `
                <strong>📊 效能分析結果:</strong><br>
                成功率: ${successRate}% (${passed}/${total})<br>
                平均耗時: ${avgDuration}ms<br>
                最快: ${minDuration}ms | 最慢: ${maxDuration}ms<br>
            `;
            
            if (successRate === 100) {
                analysis += '<br><span style="color: #28a745;">🎉 所有壓力測試通過！系統穩定性極佳</span>';
            } else if (successRate >= 90) {
                analysis += '<br><span style="color: #ffc107;">⚠️ 大部分測試通過，系統基本穩定</span>';
            } else {
                analysis += '<br><span style="color: #dc3545;">❌ 多項測試失敗，需要優化</span>';
            }
            
            document.getElementById('performanceAnalysis').innerHTML = analysis;
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('performanceAnalysis').innerHTML = '<div class="info">尚未開始分析...</div>';
            updateStats();
            updateProgress(0, '結果已清除');
        }
        
        window.addEventListener('load', function() {
            console.log('壓力測試頁面載入完成');
        });
    </script>
</body>
</html>